<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kubeadm 安装单master集群 | 戴先森的学习笔记</title>
<meta name=keywords content="kubernetes"><meta name=description content="环境准备
系统及软件版本

kubernetes version: v1.16.3


  
      
          组件
          版本
          说明
      
  
  
      
          Centos
          7.7
          操作系统
      
      
          kubeadm
          v1.16.3
          集群部署工具
      
      
          etcd
          3.3.15
          存储数据库
      
      
          calico
          v3.14.0
          CNI 网络插件
      
      
          docker
          18.09.9
          CRI Runtime
      
      
          metallb
          v0.8.3
          穷人版 LoadBalancer
      
  

主机列表

  
      
          hostname
          IP Address
          components
      
  
  
      
          k8s-master
          10.64.144.100
          kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker
      
      
          k8s-node01
          10.64.144.101
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node02
          10.64.144.102
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node03
          10.64.144.103
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node04
          10.64.144.104
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node05
          10.64.144.105
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node06
          10.64.144.106
          kube-proxy,kubelet,flannel,docker
      
  

网络规划

  
      
          功能
          网段
      
  
  
      
          Pod 网络
          172.16.0.0/16
      
      
          Service 网络
          10.96.0.0/12
      
      
          DNS 地址
          10.96.0.10
      
      
          LoadBalance
          10.64.144.150~10.64.144.200
      
  

系统初始化

所有节点上都需要操作"><meta name=author content="Xijun Dai"><link rel=canonical href=https://linuxyunwei.com/posts/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxyunwei.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxyunwei.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxyunwei.com/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxyunwei.com/apple-touch-icon.png><link rel=mask-icon href=https://linuxyunwei.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://linuxyunwei.com/posts/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://linuxyunwei.com/posts/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/"><meta property="og:site_name" content="戴先森的学习笔记"><meta property="og:title" content="kubeadm 安装单master集群"><meta property="og:description" content="环境准备 系统及软件版本 kubernetes version: v1.16.3
组件 版本 说明 Centos 7.7 操作系统 kubeadm v1.16.3 集群部署工具 etcd 3.3.15 存储数据库 calico v3.14.0 CNI 网络插件 docker 18.09.9 CRI Runtime metallb v0.8.3 穷人版 LoadBalancer 主机列表 hostname IP Address components k8s-master 10.64.144.100 kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker k8s-node01 10.64.144.101 kube-proxy,kubelet,flannel,docker k8s-node02 10.64.144.102 kube-proxy,kubelet,flannel,docker k8s-node03 10.64.144.103 kube-proxy,kubelet,flannel,docker k8s-node04 10.64.144.104 kube-proxy,kubelet,flannel,docker k8s-node05 10.64.144.105 kube-proxy,kubelet,flannel,docker k8s-node06 10.64.144.106 kube-proxy,kubelet,flannel,docker 网络规划 功能 网段 Pod 网络 172.16.0.0/16 Service 网络 10.96.0.0/12 DNS 地址 10.96.0.10 LoadBalance 10.64.144.150~10.64.144.200 系统初始化 所有节点上都需要操作"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-18T19:12:02+08:00"><meta property="article:modified_time" content="2019-11-18T19:12:02+08:00"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="kubeadm 安装单master集群"><meta name=twitter:description content="环境准备
系统及软件版本

kubernetes version: v1.16.3


  
      
          组件
          版本
          说明
      
  
  
      
          Centos
          7.7
          操作系统
      
      
          kubeadm
          v1.16.3
          集群部署工具
      
      
          etcd
          3.3.15
          存储数据库
      
      
          calico
          v3.14.0
          CNI 网络插件
      
      
          docker
          18.09.9
          CRI Runtime
      
      
          metallb
          v0.8.3
          穷人版 LoadBalancer
      
  

主机列表

  
      
          hostname
          IP Address
          components
      
  
  
      
          k8s-master
          10.64.144.100
          kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker
      
      
          k8s-node01
          10.64.144.101
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node02
          10.64.144.102
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node03
          10.64.144.103
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node04
          10.64.144.104
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node05
          10.64.144.105
          kube-proxy,kubelet,flannel,docker
      
      
          k8s-node06
          10.64.144.106
          kube-proxy,kubelet,flannel,docker
      
  

网络规划

  
      
          功能
          网段
      
  
  
      
          Pod 网络
          172.16.0.0/16
      
      
          Service 网络
          10.96.0.0/12
      
      
          DNS 地址
          10.96.0.10
      
      
          LoadBalance
          10.64.144.150~10.64.144.200
      
  

系统初始化

所有节点上都需要操作"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxyunwei.com/posts/"},{"@type":"ListItem","position":2,"name":"kubeadm 安装单master集群","item":"https://linuxyunwei.com/posts/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubeadm 安装单master集群","name":"kubeadm 安装单master集群","description":"环境准备 系统及软件版本 kubernetes version: v1.16.3\n组件 版本 说明 Centos 7.7 操作系统 kubeadm v1.16.3 集群部署工具 etcd 3.3.15 存储数据库 calico v3.14.0 CNI 网络插件 docker 18.09.9 CRI Runtime metallb v0.8.3 穷人版 LoadBalancer 主机列表 hostname IP Address components k8s-master 10.64.144.100 kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker k8s-node01 10.64.144.101 kube-proxy,kubelet,flannel,docker k8s-node02 10.64.144.102 kube-proxy,kubelet,flannel,docker k8s-node03 10.64.144.103 kube-proxy,kubelet,flannel,docker k8s-node04 10.64.144.104 kube-proxy,kubelet,flannel,docker k8s-node05 10.64.144.105 kube-proxy,kubelet,flannel,docker k8s-node06 10.64.144.106 kube-proxy,kubelet,flannel,docker 网络规划 功能 网段 Pod 网络 172.16.0.0/16 Service 网络 10.96.0.0/12 DNS 地址 10.96.0.10 LoadBalance 10.64.144.150~10.64.144.200 系统初始化 所有节点上都需要操作\n","keywords":["kubernetes"],"articleBody":"环境准备 系统及软件版本 kubernetes version: v1.16.3\n组件 版本 说明 Centos 7.7 操作系统 kubeadm v1.16.3 集群部署工具 etcd 3.3.15 存储数据库 calico v3.14.0 CNI 网络插件 docker 18.09.9 CRI Runtime metallb v0.8.3 穷人版 LoadBalancer 主机列表 hostname IP Address components k8s-master 10.64.144.100 kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker k8s-node01 10.64.144.101 kube-proxy,kubelet,flannel,docker k8s-node02 10.64.144.102 kube-proxy,kubelet,flannel,docker k8s-node03 10.64.144.103 kube-proxy,kubelet,flannel,docker k8s-node04 10.64.144.104 kube-proxy,kubelet,flannel,docker k8s-node05 10.64.144.105 kube-proxy,kubelet,flannel,docker k8s-node06 10.64.144.106 kube-proxy,kubelet,flannel,docker 网络规划 功能 网段 Pod 网络 172.16.0.0/16 Service 网络 10.96.0.0/12 DNS 地址 10.96.0.10 LoadBalance 10.64.144.150~10.64.144.200 系统初始化 所有节点上都需要操作\n配置 hosts 同步 $ cat \u003e /etc/hosts \u003c","wordCount":"6547","inLanguage":"zh-cn","datePublished":"2019-11-18T19:12:02+08:00","dateModified":"2019-11-18T19:12:02+08:00","author":{"@type":"Person","name":"Xijun Dai"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxyunwei.com/posts/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/"},"publisher":{"@type":"Organization","name":"戴先森的学习笔记","logo":{"@type":"ImageObject","url":"https://linuxyunwei.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxyunwei.com/ accesskey=h title="戴先森的学习笔记 (Alt + H)">戴先森的学习笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxyunwei.com/ title=Home><span>Home</span></a></li><li><a href=https://linuxyunwei.com/articles/ title=Articles><span>Articles</span></a></li><li><a href=https://linuxyunwei.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://linuxyunwei.com/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxyunwei.com/>Home</a>&nbsp;»&nbsp;<a href=https://linuxyunwei.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">kubeadm 安装单master集群</h1><div class=post-meta><span title='2019-11-18 19:12:02 +0800 +0800'>November 18, 2019</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;6547 words&nbsp;·&nbsp;Xijun Dai&nbsp;|&nbsp;<a href=https://github.com/linuxyunwei/linuxyunwei.com/tree/master/content/posts/kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4.md rel="noopener noreferrer" target=_blank>修正错误</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#环境准备>环境准备</a><ul><li><a href=#系统及软件版本>系统及软件版本</a></li><li><a href=#主机列表>主机列表</a></li><li><a href=#网络规划>网络规划</a></li></ul></li><li><a href=#系统初始化>系统初始化</a><ul><li><a href=#配置-hosts-同步>配置 hosts 同步</a></li><li><a href=#设置主机名>设置主机名</a></li><li><a href=#更新系统>更新系统</a></li><li><a href=#更新内核>更新内核</a></li><li><a href=#配置网卡驱动可选>配置网卡驱动(可选)</a></li><li><a href=#重启后验证内核版本>重启后验证内核版本</a></li><li><a href=#禁用-selinux>禁用 SELinux</a></li><li><a href=#禁用-swap>禁用 swap</a></li><li><a href=#禁用不需要的服务>禁用不需要的服务</a></li><li><a href=#安装必要工具>安装必要工具</a></li><li><a href=#优化系统内核>优化系统内核</a></li><li><a href=#开启-ipvs-支持>开启 ipvs 支持</a></li><li><a href=#时间同步>时间同步</a></li><li><a href=#运行-docker-检测脚本>运行 docker 检测脚本</a></li><li><a href=#重启系统>重启系统</a></li></ul></li><li><a href=#安装-docker>安装 Docker</a><ul><li><a href=#安装>安装</a></li><li><a href=#修改配置文件>修改配置文件</a></li><li><a href=#启动并检查配置是否生效>启动并检查配置是否生效</a></li></ul></li><li><a href=#安装-kubernetes-相关工具>安装 kubernetes 相关工具</a><ul><li><a href=#添加阿里云-yum-源>添加阿里云 YUM 源</a></li><li><a href=#查看支持的版本列表>查看支持的版本列表</a></li><li><a href=#安装-kubeadmkubectlkubelet-工具>安装 kubeadm、kubectl、kubelet 工具</a></li><li><a href=#添加-kubelet-开机自启动>添加 kubelet 开机自启动</a></li></ul></li><li><a href=#初始化集群>初始化集群</a><ul><li><a href=#生成-kubeadm-配置文件>生成 kubeadm 配置文件</a></li><li><a href=#修改配置>修改配置</a></li><li><a href=#下载所需镜像可选>下载所需镜像(可选)</a></li><li><a href=#初始化>初始化</a></li><li><a href=#配置-kubeconfig>配置 kubeconfig</a></li></ul></li><li><a href=#加入-worker-节点到集群>加入 worker 节点到集群</a></li><li><a href=#安装-cni-网络插件>安装 CNI 网络插件</a><ul><li><a href=#下载-calicoyaml>下载 calico.yaml</a></li><li><a href=#部署>部署</a></li><li><a href=#通过-calicoctl-查看-bgp-节点状态>通过 calicoctl 查看 BGP 节点状态</a></li><li><a href=#确认查看集群状态>确认查看集群状态</a></li></ul></li><li><a href=#配置节点之间流量加密-可选>配置节点之间流量加密 (可选)</a></li><li><a href=#测试>测试</a><ul><li><a href=#创建-pod-测试集群是否能正常工作>创建 pod 测试集群是否能正常工作</a></li><li><a href=#测试-coredns-能否正常工作>测试 coredns 能否正常工作</a></li></ul></li><li><a href=#安装-ingress>安装 Ingress</a></li><li><a href=#部署-metallb>部署 Metallb</a></li><li><a href=#测试-ingress-nginx-及-metallb>测试 ingress-nginx 及 metallb</a></li></ul></nav></div></details></div><div class=post-content><h2 id=环境准备>环境准备<a hidden class=anchor aria-hidden=true href=#环境准备>#</a></h2><h3 id=系统及软件版本>系统及软件版本<a hidden class=anchor aria-hidden=true href=#系统及软件版本>#</a></h3><blockquote><p>kubernetes version: v1.16.3</p></blockquote><table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>Centos</td><td>7.7</td><td>操作系统</td></tr><tr><td>kubeadm</td><td>v1.16.3</td><td>集群部署工具</td></tr><tr><td>etcd</td><td>3.3.15</td><td>存储数据库</td></tr><tr><td>calico</td><td>v3.14.0</td><td>CNI 网络插件</td></tr><tr><td>docker</td><td>18.09.9</td><td>CRI Runtime</td></tr><tr><td>metallb</td><td>v0.8.3</td><td>穷人版 LoadBalancer</td></tr></tbody></table><h3 id=主机列表>主机列表<a hidden class=anchor aria-hidden=true href=#主机列表>#</a></h3><table><thead><tr><th>hostname</th><th>IP Address</th><th>components</th></tr></thead><tbody><tr><td>k8s-master</td><td>10.64.144.100</td><td>kube-apiserver,kube-controller-manager,kube-scheduler,etcd,kubelet,flannel,docker</td></tr><tr><td>k8s-node01</td><td>10.64.144.101</td><td>kube-proxy,kubelet,flannel,docker</td></tr><tr><td>k8s-node02</td><td>10.64.144.102</td><td>kube-proxy,kubelet,flannel,docker</td></tr><tr><td>k8s-node03</td><td>10.64.144.103</td><td>kube-proxy,kubelet,flannel,docker</td></tr><tr><td>k8s-node04</td><td>10.64.144.104</td><td>kube-proxy,kubelet,flannel,docker</td></tr><tr><td>k8s-node05</td><td>10.64.144.105</td><td>kube-proxy,kubelet,flannel,docker</td></tr><tr><td>k8s-node06</td><td>10.64.144.106</td><td>kube-proxy,kubelet,flannel,docker</td></tr></tbody></table><h3 id=网络规划>网络规划<a hidden class=anchor aria-hidden=true href=#网络规划>#</a></h3><table><thead><tr><th>功能</th><th>网段</th></tr></thead><tbody><tr><td>Pod 网络</td><td>172.16.0.0/16</td></tr><tr><td>Service 网络</td><td>10.96.0.0/12</td></tr><tr><td>DNS 地址</td><td>10.96.0.10</td></tr><tr><td>LoadBalance</td><td>10.64.144.150~10.64.144.200</td></tr></tbody></table><h2 id=系统初始化>系统初始化<a hidden class=anchor aria-hidden=true href=#系统初始化>#</a></h2><blockquote><p>所有节点上都需要操作</p></blockquote><h3 id=配置-hosts-同步>配置 hosts 同步<a hidden class=anchor aria-hidden=true href=#配置-hosts-同步>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; /etc/hosts <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span></span><span class=line><span class=cl><span class=s>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.100   k8s-master
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.101   k8s-node01
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.102   k8s-node02
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.103   k8s-node03
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.104   k8s-node04
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.105   k8s-node05
</span></span></span><span class=line><span class=cl><span class=s>10.64.144.106   k8s-node06
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=设置主机名>设置主机名<a hidden class=anchor aria-hidden=true href=#设置主机名>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>hostnamectl set-hostname k8s-master <span class=c1># 分别设置所有节点的主机名</span>
</span></span></code></pre></div><h3 id=更新系统>更新系统<a hidden class=anchor aria-hidden=true href=#更新系统>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum update -y
</span></span></code></pre></div><h3 id=更新内核>更新内核<a hidden class=anchor aria-hidden=true href=#更新内核>#</a></h3><p>安装稳定版主线内核</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span class=line><span class=cl>yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm
</span></span><span class=line><span class=cl>yum install -y --enablerepo<span class=o>=</span>elrepo-kernel kernel-ml kernel-ml-headers kernel-ml-devel
</span></span></code></pre></div><p>查看系统中已安装的内核版本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ awk -F<span class=se>\&#39;</span> <span class=s1>&#39;$1==&#34;menuentry &#34; {print i++ &#34; : &#34; $2}&#39;</span> /etc/grub2.cfg
</span></span><span class=line><span class=cl><span class=m>0</span> : CentOS Linux <span class=o>(</span>5.6.13-1.el7.elrepo.x86_64<span class=o>)</span> <span class=m>7</span> <span class=o>(</span>Core<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=m>1</span> : CentOS Linux <span class=o>(</span>3.10.0-1062.4.1.el7.x86_64<span class=o>)</span> <span class=m>7</span> <span class=o>(</span>Core<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=m>2</span> : CentOS Linux <span class=o>(</span>3.10.0-957.el7.x86_64<span class=o>)</span> <span class=m>7</span> <span class=o>(</span>Core<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=m>3</span> : CentOS Linux <span class=o>(</span>0-rescue-4097349c950a4862a8fab2587d598af7<span class=o>)</span> <span class=m>7</span> <span class=o>(</span>Core<span class=o>)</span>
</span></span></code></pre></div><p>切换默认内核</p><blockquote><p><code>0</code> 为上面列出的序号，比如我这里 <code>0</code> 代表 <code>5.6.13</code> 这个版本的内核</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ grub2-set-default <span class=m>0</span>
</span></span><span class=line><span class=cl>$ grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class=line><span class=cl>Generating grub configuration file ...
</span></span><span class=line><span class=cl>Found linux image: /boot/vmlinuz-5.6.13-1.el7.elrepo.x86_64
</span></span><span class=line><span class=cl>Found initrd image: /boot/initramfs-5.6.13-1.el7.elrepo.x86_64.img
</span></span><span class=line><span class=cl>Found linux image: /boot/vmlinuz-3.10.0-1062.4.1.el7.x86_64
</span></span><span class=line><span class=cl>Found initrd image: /boot/initramfs-3.10.0-1062.4.1.el7.x86_64.img
</span></span><span class=line><span class=cl>Found linux image: /boot/vmlinuz-3.10.0-957.el7.x86_64
</span></span><span class=line><span class=cl>Found initrd image: /boot/initramfs-3.10.0-957.el7.x86_64.img
</span></span><span class=line><span class=cl>Found linux image: /boot/vmlinuz-0-rescue-4097349c950a4862a8fab2587d598af7
</span></span><span class=line><span class=cl>Found initrd image: /boot/initramfs-0-rescue-4097349c950a4862a8fab2587d598af7.img
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h3 id=配置网卡驱动可选>配置网卡驱动(可选)<a hidden class=anchor aria-hidden=true href=#配置网卡驱动可选>#</a></h3><blockquote><p>实验环境中由于使用的是普通 PC，板载网卡为 realtek r8168/r8169, 这个网卡在 5.x 版本内核中由于缺少加载 realtek.ko 模块会造成无法正常识别到网卡的情况</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkinitrd --force --preload realtek /boot/initramfs-<span class=sb>`</span>uname -r<span class=sb>`</span>.img <span class=sb>`</span>uname -r<span class=sb>`</span>
</span></span><span class=line><span class=cl>$ lsinitrd /boot/initramfs-<span class=sb>`</span>uname -r<span class=sb>`</span>.img <span class=p>|</span> grep realtek
</span></span><span class=line><span class=cl>Arguments: -f --add-drivers <span class=s1>&#39; realtek&#39;</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>-rwxr--r--   <span class=m>1</span> root     root       <span class=m>127880</span> Jan  <span class=m>7</span> 16:21 usr/lib/modules/5.6.13-1.el7.elrepo.x86_64/kernel/drivers/net/ethernet/realtek/r8169.ko
</span></span><span class=line><span class=cl>-rwxr--r--   <span class=m>1</span> root     root        <span class=m>27360</span> Jan  <span class=m>7</span> 16:21 usr/lib/modules/5.6.13-1.el7.elrepo.x86_64/kernel/drivers/net/phy/realtek.ko
</span></span></code></pre></div><p>确保有加载 <code>realtek.ko</code> 和 <code>r8169.ko</code> 模块</p><h3 id=重启后验证内核版本>重启后验证内核版本<a hidden class=anchor aria-hidden=true href=#重启后验证内核版本>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ uname -r
</span></span><span class=line><span class=cl>5.6.13-1.el7.elrepo.x86_64
</span></span></code></pre></div><h3 id=禁用-selinux>禁用 SELinux<a hidden class=anchor aria-hidden=true href=#禁用-selinux>#</a></h3><p>如果不禁用 selinux，挂载目录会出现 <code>Permission deined</code> 错误</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sed -i <span class=s1>&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config  <span class=c1># 永久关闭</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>  <span class=c1># 临时关闭</span>
</span></span></code></pre></div><h3 id=禁用-swap>禁用 swap<a hidden class=anchor aria-hidden=true href=#禁用-swap>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>swapoff -a
</span></span><span class=line><span class=cl>sed -i -r <span class=s1>&#39;s/(.+ swap .*)/# \1/&#39;</span> /etc/fstab
</span></span><span class=line><span class=cl>sysctl -w vm.swappiness<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/sysctl.d/swap.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>vm.swappiness=0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sysctl -p /etc/sysctl.d/swap.conf
</span></span></code></pre></div><h3 id=禁用不需要的服务>禁用不需要的服务<a hidden class=anchor aria-hidden=true href=#禁用不需要的服务>#</a></h3><p>如果选择不关闭<code>firewalld</code>，请参考官方文档中放行相应的端口 <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports>check-required-ports</a></p><p>最少化安装的 Centos 中貌似没有安装 dnsmasq，如果有安装则需要将其禁用，否则它会把节点上的 DNS server 设置为 127.0.0.1,将会导致 Docker 无法解析域名</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl disable --now firewalld NetworkManager dnsmasq
</span></span></code></pre></div><h3 id=安装必要工具>安装必要工具<a hidden class=anchor aria-hidden=true href=#安装必要工具>#</a></h3><p>kube-proxy 的 ipvs 模式下依赖<code>ipvsadm</code>,<code>ipset</code>用于配置及管理规则</p><p><code>kubectl port-forward</code>命令依赖<code>socat</code>做端口转发</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install -y ipvsadm ipset sysstat conntrack libseccomp socat wget git jq curl
</span></span></code></pre></div><h3 id=优化系统内核>优化系统内核<a hidden class=anchor aria-hidden=true href=#优化系统内核>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; /etc/sysctl.d/k8s.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># https://github.com/moby/moby/issues/31208
</span></span></span><span class=line><span class=cl><span class=s># ipvsadm -l --timout
</span></span></span><span class=line><span class=cl><span class=s># 修复ipvs模式下长连接timeout问题 小于900即可
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_time = 600
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_intvl = 30
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_probes = 10
</span></span></span><span class=line><span class=cl><span class=s># 关闭ipv6
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.all.disable_ipv6 = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.default.disable_ipv6 = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.lo.disable_ipv6 = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.neigh.default.gc_stale_time = 120
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.conf.all.rp_filter = 0
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.conf.default.rp_filter = 0
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.conf.default.arp_announce = 2
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.conf.lo.arp_announce = 2
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.conf.all.arp_announce = 2
</span></span></span><span class=line><span class=cl><span class=s># 开启路由转发
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_tw_buckets = 5000
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_syncookies = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog = 1024
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_synack_retries = 2
</span></span></span><span class=line><span class=cl><span class=s># 开启 bridge-netfilter, 使用iptables规则可以作用于bridge模式
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-arptables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.netfilter.nf_conntrack_max = 2310720
</span></span></span><span class=line><span class=cl><span class=s>fs.inotify.max_user_watches=89100
</span></span></span><span class=line><span class=cl><span class=s>fs.may_detach_mounts = 1
</span></span></span><span class=line><span class=cl><span class=s>fs.file-max = 52706963
</span></span></span><span class=line><span class=cl><span class=s>fs.nr_open = 52706963
</span></span></span><span class=line><span class=cl><span class=s>vm.overcommit_memory=1
</span></span></span><span class=line><span class=cl><span class=s>vm.panic_on_oom=0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>$ sysctl --system  <span class=c1># 使配置生效</span>
</span></span></code></pre></div><h3 id=开启-ipvs-支持>开启 ipvs 支持<a hidden class=anchor aria-hidden=true href=#开启-ipvs-支持>#</a></h3><blockquote><p>如果内核版本小于 <code>4.19</code>, 需要将 <code>nf_conntrack</code> 修改为 <code>nf_conntrack_ipv4</code></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 临时生效</span>
</span></span><span class=line><span class=cl>modprobe -- ip_vs
</span></span><span class=line><span class=cl>modprobe -- ip_vs_rr
</span></span><span class=line><span class=cl>modprobe -- ip_vs_wrr
</span></span><span class=line><span class=cl>modprobe -- ip_vs_sh
</span></span><span class=line><span class=cl>modprobe -- nf_conntrack
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 永久生效</span>
</span></span><span class=line><span class=cl>$ cat &gt; /etc/sysconfig/modules/ipvs.modules <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=s>modules=(
</span></span></span><span class=line><span class=cl><span class=s>ip_vs
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_rr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_wrr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_sh
</span></span></span><span class=line><span class=cl><span class=s>nf_conntrack_ipv4
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>)
</span></span></span><span class=line><span class=cl><span class=s>for mod in ${modules[@]}
</span></span></span><span class=line><span class=cl><span class=s>do
</span></span></span><span class=line><span class=cl><span class=s>  /sbin/modinfo -F filename ${mod} &gt; /dev/null 2&gt;&amp;1
</span></span></span><span class=line><span class=cl><span class=s>  if [ $? -eq 0 ]
</span></span></span><span class=line><span class=cl><span class=s>  then
</span></span></span><span class=line><span class=cl><span class=s>      /sbin/modprobe ${mod}
</span></span></span><span class=line><span class=cl><span class=s>  fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>chmod +x /etc/sysconfig/modules/ipvs.modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查内核模块是否已经加载</span>
</span></span><span class=line><span class=cl>$ lsmod <span class=p>|</span> grep ip_vs
</span></span><span class=line><span class=cl>ip_vs_sh               <span class=m>12688</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_wrr              <span class=m>12697</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_rr               <span class=m>12600</span>  <span class=m>4</span>
</span></span><span class=line><span class=cl>ip_vs                 <span class=m>145497</span>  <span class=m>10</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
</span></span><span class=line><span class=cl>nf_conntrack          <span class=m>139224</span>  <span class=m>7</span> ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack
</span></span><span class=line><span class=cl>libcrc32c              <span class=m>12644</span>  <span class=m>4</span> xfs,ip_vs,nf_nat,nf_conntrack
</span></span></code></pre></div><h3 id=时间同步>时间同步<a hidden class=anchor aria-hidden=true href=#时间同步>#</a></h3><p>所有节点配置为同一时区，并使用 <code>chrony</code> 同步节点的时间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;Asia/Shanghai&#34;</span> &gt; /etc/timezone
</span></span><span class=line><span class=cl>$ yum install chrony -y
</span></span><span class=line><span class=cl>$ cat &gt; /etc/chrony.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>server ntp.aliyun.com iburst
</span></span></span><span class=line><span class=cl><span class=s>stratumweight 0
</span></span></span><span class=line><span class=cl><span class=s>driftfile /var/lib/chrony/drift
</span></span></span><span class=line><span class=cl><span class=s>rtcsync
</span></span></span><span class=line><span class=cl><span class=s>makestep 10 3
</span></span></span><span class=line><span class=cl><span class=s>bindcmdaddress 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s>bindcmdaddress ::1
</span></span></span><span class=line><span class=cl><span class=s>keyfile /etc/chrony.keys
</span></span></span><span class=line><span class=cl><span class=s>commandkey 1
</span></span></span><span class=line><span class=cl><span class=s>generatecommandkey
</span></span></span><span class=line><span class=cl><span class=s>logchange 0.5
</span></span></span><span class=line><span class=cl><span class=s>logdir /var/log/chrony
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> --now chronyd
</span></span></code></pre></div><h3 id=运行-docker-检测脚本>运行 docker 检测脚本<a hidden class=anchor aria-hidden=true href=#运行-docker-检测脚本>#</a></h3><p>docker 官方提供了脚本用于检查内核相关配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=hl><span class=lnt> 9
</span></span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=se>\$</span> curl -fsSL &lt;https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh&gt; <span class=p>|</span> bash -s
</span></span><span class=line><span class=cl>info: reading kernel config from /boot/config-3.10.0-1062.4.3.el7.x86_64 ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Generally Necessary:
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Optional Features:
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>- CONFIG_USER_NS: enabled
</span></span><span class=line><span class=cl>  <span class=o>(</span>RHEL7/CentOS7: User namespaces disabled<span class=p>;</span> add <span class=s1>&#39;user_namespace.enable=1&#39;</span> to boot <span class=nb>command</span> line<span class=o>)</span>
</span></span><span class=line><span class=cl>- CONFIG_SECCOMP: enabled
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  </span></span></code></pre></td></tr></table></div></div><p>如上高亮行所示，开启 user_namespace</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ grubby --args<span class=o>=</span><span class=s2>&#34;user_namespace.enable=1&#34;</span> --update-kernel<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>grubby --default-kernel<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>$ grep user_namespace /etc/grub2.cfg
</span></span><span class=line><span class=cl>        linux16 /vmlinuz-5.6.13-1.el7.elrepo.x86_64 <span class=nv>root</span><span class=o>=</span>/dev/mapper/centos-root ro <span class=nv>crashkernel</span><span class=o>=</span>auto rd.lvm.lv<span class=o>=</span>centos/root rhgb quiet user_namespace.enable<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><h3 id=重启系统>重启系统<a hidden class=anchor aria-hidden=true href=#重启系统>#</a></h3><p>重启系统以使配置生效</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl reboot
</span></span></code></pre></div><h2 id=安装-docker>安装 Docker<a hidden class=anchor aria-hidden=true href=#安装-docker>#</a></h2><blockquote><p>所有节点上均需配置</p></blockquote><p>虽然 Kubernetes 支持多种容器运行环境，如 <code>Docker</code>, <code>Containerd</code>, <code>CRI-O</code> 等，但目前 <code>Docker</code> 还是主流</p><p>关于容器运行环境可以参考官方文档 <a href=https://kubernetes.io/docs/setup/production-environment/container-runtimes/>Container Runntimes</a></p><p>支持的 Docker 版本列表请查看官方 <a href=https://github.com/kubernetes/kubernetes/blob/v1.16.3/CHANGELOG-1.16.md>CHANGELOG</a> 搜索 <code>The list of validated docker versions</code> 关键字</p><h3 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h3><p>官方推荐使用 <code>18.06.2</code>, 我这里使用的是 <code>18.09.9</code></p><p>Docker 官方的 yum 源在国内可能会访问不到，这里使用了阿里云的镜像源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>VERSION</span><span class=o>=</span>18.09
</span></span><span class=line><span class=cl>curl -fsSL https://get.docker.com <span class=p>|</span> bash -s docker --mirror Aliyun
</span></span></code></pre></div><h3 id=修改配置文件>修改配置文件<a hidden class=anchor aria-hidden=true href=#修改配置文件>#</a></h3><p>主要修改以下几个参数:</p><ul><li><code>native.cgroupdriver</code>: 官方推荐使用 <code>systemd</code> 来管理 cgroup,且必须与 kubelet 的<code>--cgroup-driver</code>参数一致</li><li><code>storage-driver</code>: 存储驱动，<code>overlay2</code> 会比其他驱动更好的性能。如果文件系统为<code>XFS</code>，请确保<code>ftype=1</code>(可使用 <code>xfs_info</code> 查看),否则 docker 会无法启动，报错信息<code>Error starting daemon: error initializing graphdriver: overlay2: the backing xfs filesystem is formatted without d_type support, which leads to incorrect behavior. Reformat the filesystem with ftype=1 to enable d_type support. Backing filesystems without d_type support are not supported.</code></li><li><code>registry-mirrors</code>: 加速从 dockerhub 拉取镜像</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir /etc/docker
</span></span><span class=line><span class=cl>cat &gt; /etc/docker/daemon.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;registry-mirrors&#34;: [&#34;https://8jg6za8m.mirror.aliyuncs.com&#34;],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;storage-opts&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    &#34;overlay2.override_kernel_check=true&#34;
</span></span></span><span class=line><span class=cl><span class=s>  ],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-opts&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;max-size&#34;: &#34;100m&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;max-file&#34;: &#34;3&#34;
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动并检查配置是否生效>启动并检查配置是否生效<a hidden class=anchor aria-hidden=true href=#启动并检查配置是否生效>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> --now docker
</span></span><span class=line><span class=cl>Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
</span></span><span class=line><span class=cl>$ docker version
</span></span><span class=line><span class=cl>Client:
</span></span><span class=line><span class=cl> Version:           18.09.9
</span></span><span class=line><span class=cl> API version:       1.39
</span></span><span class=line><span class=cl> Go version:        go1.11.13
</span></span><span class=line><span class=cl> Git commit:        039a7df9ba
</span></span><span class=line><span class=cl> Built:             Wed Sep  <span class=m>4</span> 16:51:21 <span class=m>2019</span>
</span></span><span class=line><span class=cl> OS/Arch:           linux/amd64
</span></span><span class=line><span class=cl> Experimental:      <span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Server: Docker Engine - Community
</span></span><span class=line><span class=cl> Engine:
</span></span><span class=line><span class=cl>  Version:          18.09.9
</span></span><span class=line><span class=cl>  API version:      1.39 <span class=o>(</span>minimum version 1.12<span class=o>)</span>
</span></span><span class=line><span class=cl>  Go version:       go1.11.13
</span></span><span class=line><span class=cl>  Git commit:       039a7df
</span></span><span class=line><span class=cl>  Built:            Wed Sep  <span class=m>4</span> 16:22:32 <span class=m>2019</span>
</span></span><span class=line><span class=cl>  OS/Arch:          linux/amd64
</span></span><span class=line><span class=cl>  Experimental:     <span class=nb>false</span>
</span></span><span class=line><span class=cl>$ docker info
</span></span><span class=line><span class=cl>Containers: <span class=m>0</span>
</span></span><span class=line><span class=cl> Running: <span class=m>0</span>
</span></span><span class=line><span class=cl> Paused: <span class=m>0</span>
</span></span><span class=line><span class=cl> Stopped: <span class=m>0</span>
</span></span><span class=line><span class=cl>Images: <span class=m>0</span>
</span></span><span class=line><span class=cl>Server Version: 18.09.9
</span></span><span class=line><span class=cl>Storage Driver: overlay2
</span></span><span class=line><span class=cl> Backing Filesystem: xfs
</span></span><span class=line><span class=cl> Supports d_type: <span class=nb>true</span>
</span></span><span class=line><span class=cl> Native Overlay Diff: <span class=nb>true</span>
</span></span><span class=line><span class=cl>Logging Driver: json-file
</span></span><span class=line><span class=cl>Cgroup Driver: systemd
</span></span><span class=line><span class=cl>Plugins:
</span></span><span class=line><span class=cl> Volume: <span class=nb>local</span>
</span></span><span class=line><span class=cl> Network: bridge host macvlan null overlay
</span></span><span class=line><span class=cl> Log: awslogs fluentd gcplogs gelf journald json-file <span class=nb>local</span> logentries splunk syslog
</span></span><span class=line><span class=cl>Swarm: inactive
</span></span><span class=line><span class=cl>Runtimes: runc
</span></span><span class=line><span class=cl>Default Runtime: runc
</span></span><span class=line><span class=cl>Init Binary: docker-init
</span></span><span class=line><span class=cl>containerd version: b34a5c8af56e510852c35414db4c1f4fa6172339
</span></span><span class=line><span class=cl>runc version: 3e425f80a8c931f88e6d94a8c831b9d5aa481657
</span></span><span class=line><span class=cl>init version: fec3683
</span></span><span class=line><span class=cl>Security Options:
</span></span><span class=line><span class=cl> seccomp
</span></span><span class=line><span class=cl>  Profile: default
</span></span><span class=line><span class=cl>Kernel Version: 5.6.13-1.el7.elrepo.x86_64
</span></span><span class=line><span class=cl>Operating System: CentOS Linux <span class=m>7</span> <span class=o>(</span>Core<span class=o>)</span>
</span></span><span class=line><span class=cl>OSType: linux
</span></span><span class=line><span class=cl>Architecture: x86_64
</span></span><span class=line><span class=cl>CPUs: <span class=m>4</span>
</span></span><span class=line><span class=cl>Total Memory: 15.39GiB
</span></span><span class=line><span class=cl>Name: k8s-master
</span></span><span class=line><span class=cl>ID: BI53:OQC7:QV6C:SP3N:FBTT:N5ST:MK3I:CGLJ:X2JX:CJOH:CBEE:4GG2
</span></span><span class=line><span class=cl>Docker Root Dir: /var/lib/docker
</span></span><span class=line><span class=cl>Debug Mode <span class=o>(</span>client<span class=o>)</span>: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Debug Mode <span class=o>(</span>server<span class=o>)</span>: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Registry: https://index.docker.io/v1/
</span></span><span class=line><span class=cl>Labels:
</span></span><span class=line><span class=cl>Experimental: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Insecure Registries:
</span></span><span class=line><span class=cl> 127.0.0.0/8
</span></span><span class=line><span class=cl>Registry Mirrors:
</span></span><span class=line><span class=cl> https://8jg6za8m.mirror.aliyuncs.com/
</span></span><span class=line><span class=cl>Live Restore Enabled: <span class=nb>false</span>
</span></span><span class=line><span class=cl>Product License: Community Engine
</span></span></code></pre></div><h2 id=安装-kubernetes-相关工具>安装 kubernetes 相关工具<a hidden class=anchor aria-hidden=true href=#安装-kubernetes-相关工具>#</a></h2><blockquote><p>所有节点上操作</p></blockquote><h3 id=添加阿里云-yum-源>添加阿里云 YUM 源<a hidden class=anchor aria-hidden=true href=#添加阿里云-yum-源>#</a></h3><p>默认官方的源在国内环境下可能会访问不到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat &gt; /etc/yum.repos.d/kubernetes.repo <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=查看支持的版本列表>查看支持的版本列表<a hidden class=anchor aria-hidden=true href=#查看支持的版本列表>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ yum --disablerepo<span class=o>=</span><span class=s2>&#34;*&#34;</span> --enablerepo<span class=o>=</span><span class=s2>&#34;kubernetes&#34;</span> list available --showduplicates  <span class=p>|</span> grep <span class=s2>&#34;1.16&#34;</span>
</span></span><span class=line><span class=cl>kubeadm.x86_64                       1.16.0-0                         kubernetes
</span></span><span class=line><span class=cl>kubeadm.x86_64                       1.16.1-0                         kubernetes
</span></span><span class=line><span class=cl>kubeadm.x86_64                       1.16.2-0                         kubernetes
</span></span><span class=line><span class=cl>kubeadm.x86_64                       1.16.3-0                         kubernetes
</span></span><span class=line><span class=cl>kubectl.x86_64                       1.16.0-0                         kubernetes
</span></span><span class=line><span class=cl>kubectl.x86_64                       1.16.1-0                         kubernetes
</span></span><span class=line><span class=cl>kubectl.x86_64                       1.16.2-0                         kubernetes
</span></span><span class=line><span class=cl>kubectl.x86_64                       1.16.3-0                         kubernetes
</span></span><span class=line><span class=cl>kubelet.x86_64                       1.16.0-0                         kubernetes
</span></span><span class=line><span class=cl>kubelet.x86_64                       1.16.1-0                         kubernetes
</span></span><span class=line><span class=cl>kubelet.x86_64                       1.16.2-0                         kubernetes
</span></span><span class=line><span class=cl>kubelet.x86_64                       1.16.3-0                         kubernetes
</span></span></code></pre></div><h3 id=安装-kubeadmkubectlkubelet-工具>安装 kubeadm、kubectl、kubelet 工具<a hidden class=anchor aria-hidden=true href=#安装-kubeadmkubectlkubelet-工具>#</a></h3><blockquote><p>本次安装 <code>1.16.3</code> 版本</p></blockquote><p>worker 节点可以不安装 kubectl</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install kubeadm-1.16.3 kubectl-1.16.3 kubelet-1.16.3 -y
</span></span></code></pre></div><h3 id=添加-kubelet-开机自启动>添加 kubelet 开机自启动<a hidden class=anchor aria-hidden=true href=#添加-kubelet-开机自启动>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> --now kubelet
</span></span><span class=line><span class=cl>Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service.
</span></span><span class=line><span class=cl>$ systemctl status kubelet
</span></span><span class=line><span class=cl>● kubelet.service - kubelet: The Kubernetes Node Agent
</span></span><span class=line><span class=cl>   Loaded: loaded <span class=o>(</span>/usr/lib/systemd/system/kubelet.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: disabled<span class=o>)</span>
</span></span><span class=line><span class=cl>  Drop-In: /usr/lib/systemd/system/kubelet.service.d
</span></span><span class=line><span class=cl>           └─10-kubeadm.conf
</span></span><span class=line><span class=cl>   Active: activating <span class=o>(</span>auto-restart<span class=o>)</span> <span class=o>(</span>Result: exit-code<span class=o>)</span> since Thu 2019-11-21 10:27:34 CST<span class=p>;</span> 898ms ago
</span></span><span class=line><span class=cl>     Docs: https://kubernetes.io/docs/
</span></span><span class=line><span class=cl>  Process: <span class=m>3947</span> <span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/kubelet <span class=nv>$KUBELET_KUBECONFIG_ARGS</span> <span class=nv>$KUBELET_CONFIG_ARGS</span> <span class=nv>$KUBELET_KUBEADM_ARGS</span> <span class=nv>$KUBELET_EXTRA_ARGS</span> <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>255<span class=o>)</span>
</span></span><span class=line><span class=cl> Main PID: <span class=m>3947</span> <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>255<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nov <span class=m>21</span> 10:27:34 k8s-master systemd<span class=o>[</span>1<span class=o>]</span>: Unit kubelet.service entered failed state.
</span></span><span class=line><span class=cl>Nov <span class=m>21</span> 10:27:34 k8s-master systemd<span class=o>[</span>1<span class=o>]</span>: kubelet.service failed.
</span></span></code></pre></div><p>如上查看服务状态你会发现启动失败，不过没关系，这里可以暂时忽略，因为我们还没开始初始化集群，所以还没有生成<code>kubelet</code>的配置文件</p><p>如果 enable 时提示 <code>Unit kubelet.service could not be found.</code>，执行<code>systemctl daemon-reload</code>重载配置就可以了</p><h2 id=初始化集群>初始化集群<a hidden class=anchor aria-hidden=true href=#初始化集群>#</a></h2><blockquote><p>在 master 上操作</p></blockquote><h3 id=生成-kubeadm-配置文件>生成 kubeadm 配置文件<a hidden class=anchor aria-hidden=true href=#生成-kubeadm-配置文件>#</a></h3><p>生成默认配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm config print init-defaults --component-configs KubeProxyConfiguration,KubeletConfiguration &gt; kubeadm-config.yaml
</span></span></code></pre></div><h3 id=修改配置>修改配置<a hidden class=anchor aria-hidden=true href=#修改配置>#</a></h3><p>主要改动如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=hl><span class=lnt>  5
</span></span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=hl><span class=lnt> 12
</span></span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=hl><span class=lnt> 32
</span></span><span class=lnt> 33
</span><span class=hl><span class=lnt> 34
</span></span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=hl><span class=lnt> 37
</span></span><span class=hl><span class=lnt> 38
</span></span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=hl><span class=lnt> 49
</span></span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=hl><span class=lnt> 72
</span></span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=hl><span class=lnt> 97
</span></span><span class=hl><span class=lnt> 98
</span></span><span class=hl><span class=lnt> 99
</span></span><span class=hl><span class=lnt>100
</span></span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bootstrapTokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=l>system:bootstrappers:kubeadm:default-node-token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>d7cb0e.605fb37fed0895d3</span><span class=w> </span><span class=c># 使用命令 echo &#34;$(openssl rand -hex 3).$(openssl rand -hex 8)&#34; 生成</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=l>24h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>usages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>signing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InitConfiguration</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>localAPIEndpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>advertiseAddress</span><span class=p>:</span><span class=w> </span><span class=m>10.64.144.100</span><span class=w> </span><span class=c># Master 节点的本机 IP 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bindPort</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeRegistration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>criSocket</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/dockershim.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k8s-master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiServer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>timeoutForControlPlane</span><span class=p>:</span><span class=w> </span><span class=l>4m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certificatesDir</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controllerManager</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>CoreDNS</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>dataDir</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>registry.cn-hangzhou.aliyuncs.com/google_containers</span><span class=w> </span><span class=c># 由于默认的`k8s.gcr.io`在国内无法正常访问，这里使用阿里云的源代替</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1.16.3</span><span class=w> </span><span class=c># kubernetes 版本</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.96.0.0</span><span class=l>/12</span><span class=w> </span><span class=c># 集群 service 的网段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podSubnet</span><span class=p>:</span><span class=w> </span><span class=m>172.16.0.0</span><span class=l>/16</span><span class=w> </span><span class=c># 集群 pod 网段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeproxy.config.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bindAddress</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clientConnection</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>acceptContentTypes</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>burst</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contentType</span><span class=p>:</span><span class=w> </span><span class=l>application/vnd.kubernetes.protobuf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/kube-proxy/kubeconfig.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>qps</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterCIDR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;172.16.0.0/16&#34;</span><span class=w> </span><span class=c># 集群 pod 的网段，需要与后续部署的网络插件一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>configSyncPeriod</span><span class=p>:</span><span class=w> </span><span class=l>15m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>conntrack</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>maxPerCore</span><span class=p>:</span><span class=w> </span><span class=m>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>131072</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tcpCloseWaitTimeout</span><span class=p>:</span><span class=w> </span><span class=l>1h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tcpEstablishedTimeout</span><span class=p>:</span><span class=w> </span><span class=l>24h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enableProfiling</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>healthzBindAddress</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>10256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>hostnameOverride</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>iptables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>masqueradeAll</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>masqueradeBit</span><span class=p>:</span><span class=w> </span><span class=m>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>minSyncPeriod</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>syncPeriod</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ipvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>excludeCIDRs</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>minSyncPeriod</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>strictARP</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>syncPeriod</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeProxyConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metricsBindAddress</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>10249</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ipvs&#34;</span><span class=w> </span><span class=c># Kube-Proxy 使用 ipvs 模式， 1.11 之后的版本默认使用 ipvs 代替了 iptables。如果节点上没有启用 ipvs 内核模块，会自动降级为 iptables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodePortAddresses</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>oomScoreAdj</span><span class=p>:</span><span class=w> </span>-<span class=m>999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>portRange</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>udpIdleTimeout</span><span class=p>:</span><span class=w> </span><span class=l>250ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>winkernel</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enableDSR</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networkName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sourceVip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubelet.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>authentication</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>anonymous</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cacheTTL</span><span class=p>:</span><span class=w> </span><span class=l>2m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>x509</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>clientCAFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki/ca.crt</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>authorization</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>Webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cacheAuthorizedTTL</span><span class=p>:</span><span class=w> </span><span class=l>5m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cacheUnauthorizedTTL</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cgroupDriver</span><span class=p>:</span><span class=w> </span><span class=l>systemd</span><span class=w> </span><span class=c># cgroup 管理方式，需要与 docker 中的`native.cgroupdriver`一致，推荐使用 systemd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cgroupsPerQOS</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterDNS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.96.0.10</span><span class=w> </span><span class=c># 集群中 CoreDNS 的 Service IP 地址，需要在上面配置`networking.serviceSubnet`子网中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configMapAndSecretChangeDetectionStrategy</span><span class=p>:</span><span class=w> </span><span class=l>Watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containerLogMaxFiles</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containerLogMaxSize</span><span class=p>:</span><span class=w> </span><span class=l>10Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>contentType</span><span class=p>:</span><span class=w> </span><span class=l>application/vnd.kubernetes.protobuf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cpuCFSQuota</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cpuCFSQuotaPeriod</span><span class=p>:</span><span class=w> </span><span class=l>100ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cpuManagerPolicy</span><span class=p>:</span><span class=w> </span><span class=l>none</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cpuManagerReconcilePeriod</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableControllerAttachDetach</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableDebuggingHandlers</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enforceNodeAllocatable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>eventBurst</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>eventRecordQPS</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evictionHard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagefs.available</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memory.available</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodefs.available</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodefs.inodesFree</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evictionPressureTransitionPeriod</span><span class=p>:</span><span class=w> </span><span class=l>5m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failSwapOn</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fileCheckFrequency</span><span class=p>:</span><span class=w> </span><span class=l>20s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hairpinMode</span><span class=p>:</span><span class=w> </span><span class=l>promiscuous-bridge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>healthzBindAddress</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>healthzPort</span><span class=p>:</span><span class=w> </span><span class=m>10248</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpCheckFrequency</span><span class=p>:</span><span class=w> </span><span class=l>20s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imageGCHighThresholdPercent</span><span class=p>:</span><span class=w> </span><span class=m>85</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imageGCLowThresholdPercent</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imageMinimumGCAge</span><span class=p>:</span><span class=w> </span><span class=l>2m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>iptablesDropBit</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>iptablesMasqueradeBit</span><span class=p>:</span><span class=w> </span><span class=m>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeletConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubeAPIBurst</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubeAPIQPS</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>makeIPTablesUtilChains</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxOpenFiles</span><span class=p>:</span><span class=w> </span><span class=m>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxPods</span><span class=p>:</span><span class=w> </span><span class=m>110</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeLeaseDurationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>40</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeStatusReportFrequency</span><span class=p>:</span><span class=w> </span><span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeStatusUpdateFrequency</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>oomScoreAdj</span><span class=p>:</span><span class=w> </span>-<span class=m>999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podPidsLimit</span><span class=p>:</span><span class=w> </span>-<span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registryBurst</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registryPullQPS</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resolvConf</span><span class=p>:</span><span class=w> </span><span class=l>/etc/resolv.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rotateCertificates</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runtimeRequestTimeout</span><span class=p>:</span><span class=w> </span><span class=l>2m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serializeImagePulls</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>staticPodPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/manifests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>streamingConnectionIdleTimeout</span><span class=p>:</span><span class=w> </span><span class=l>4h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>syncFrequency</span><span class=p>:</span><span class=w> </span><span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topologyManagerPolicy</span><span class=p>:</span><span class=w> </span><span class=l>none</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeStatsAggPeriod</span><span class=p>:</span><span class=w> </span><span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span></span></span></code></pre></td></tr></table></div></div><h3 id=下载所需镜像可选>下载所需镜像(可选)<a hidden class=anchor aria-hidden=true href=#下载所需镜像可选>#</a></h3><p>初始化的时候也会自动下载所有的镜像,提前下载好镜像可减少后续初始化时的等待时间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm config images list --config kubeadm-config.yaml <span class=c1># 查看镜像列表</span>
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.16.3
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.16.3
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.16.3
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.16.3
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.15-0
</span></span><span class=line><span class=cl>registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.2
</span></span><span class=line><span class=cl>$ kubeadm config images pull --config kubeadm-config.yaml <span class=c1># 下载镜像</span>
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.16.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.16.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.16.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.16.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.15-0
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.2
</span></span></code></pre></div><h3 id=初始化>初始化<a hidden class=anchor aria-hidden=true href=#初始化>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm init --config kubeadm-config.yaml
</span></span><span class=line><span class=cl><span class=o>[</span>init<span class=o>]</span> Using Kubernetes version: v1.16.3
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> Running pre-flight checks
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> Pulling images required <span class=k>for</span> setting up a Kubernetes cluster
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> You can also perform this action in beforehand using <span class=s1>&#39;kubeadm config images pull&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Writing kubelet environment file with flags to file <span class=s2>&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Writing kubelet configuration to file <span class=s2>&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Activating the kubelet service
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Using certificateDir folder <span class=s2>&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;ca&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;apiserver&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> apiserver serving cert is signed <span class=k>for</span> DNS names <span class=o>[</span>k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span class=o>]</span> and IPs <span class=o>[</span>10.96.0.1 10.64.144.100<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;apiserver-kubelet-client&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;front-proxy-ca&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;front-proxy-client&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;etcd/ca&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;etcd/server&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> etcd/server serving cert is signed <span class=k>for</span> DNS names <span class=o>[</span>k8s-master localhost<span class=o>]</span> and IPs <span class=o>[</span>10.64.144.100 127.0.0.1 ::1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;etcd/peer&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> etcd/peer serving cert is signed <span class=k>for</span> DNS names <span class=o>[</span>k8s-master localhost<span class=o>]</span> and IPs <span class=o>[</span>10.64.144.100 127.0.0.1 ::1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;etcd/healthcheck-client&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;apiserver-etcd-client&#34;</span> certificate and key
</span></span><span class=line><span class=cl><span class=o>[</span>certs<span class=o>]</span> Generating <span class=s2>&#34;sa&#34;</span> key and public key
</span></span><span class=line><span class=cl><span class=o>[</span>kubeconfig<span class=o>]</span> Using kubeconfig folder <span class=s2>&#34;/etc/kubernetes&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubeconfig<span class=o>]</span> Writing <span class=s2>&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span class=line><span class=cl><span class=o>[</span>kubeconfig<span class=o>]</span> Writing <span class=s2>&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span class=line><span class=cl><span class=o>[</span>kubeconfig<span class=o>]</span> Writing <span class=s2>&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span class=line><span class=cl><span class=o>[</span>kubeconfig<span class=o>]</span> Writing <span class=s2>&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span class=line><span class=cl><span class=o>[</span>control-plane<span class=o>]</span> Using manifest folder <span class=s2>&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>control-plane<span class=o>]</span> Creating static Pod manifest <span class=k>for</span> <span class=s2>&#34;kube-apiserver&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>control-plane<span class=o>]</span> Creating static Pod manifest <span class=k>for</span> <span class=s2>&#34;kube-controller-manager&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>control-plane<span class=o>]</span> Creating static Pod manifest <span class=k>for</span> <span class=s2>&#34;kube-scheduler&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>etcd<span class=o>]</span> Creating static Pod manifest <span class=k>for</span> <span class=nb>local</span> etcd in <span class=s2>&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>wait-control-plane<span class=o>]</span> Waiting <span class=k>for</span> the kubelet to boot up the control plane as static Pods from directory <span class=s2>&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
</span></span><span class=line><span class=cl><span class=o>[</span>apiclient<span class=o>]</span> All control plane components are healthy after 34.001666 seconds
</span></span><span class=line><span class=cl><span class=o>[</span>upload-config<span class=o>]</span> Storing the configuration used in ConfigMap <span class=s2>&#34;kubeadm-config&#34;</span> in the <span class=s2>&#34;kube-system&#34;</span> Namespace
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet<span class=o>]</span> Creating a ConfigMap <span class=s2>&#34;kubelet-config-1.16&#34;</span> in namespace kube-system with the configuration <span class=k>for</span> the kubelets in the cluster
</span></span><span class=line><span class=cl><span class=o>[</span>upload-certs<span class=o>]</span> Skipping phase. Please see --upload-certs
</span></span><span class=line><span class=cl><span class=o>[</span>mark-control-plane<span class=o>]</span> Marking the node k8s-master as control-plane by adding the label <span class=s2>&#34;node-role.kubernetes.io/master=&#39;&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>mark-control-plane<span class=o>]</span> Marking the node k8s-master as control-plane by adding the taints <span class=o>[</span>node-role.kubernetes.io/master:NoSchedule<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> Using token: d7cb0e.605fb37fed0895d3
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span class=k>for</span> nodes to get long term certificate credentials
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> configured RBAC rules to allow certificate rotation <span class=k>for</span> all node client certificates in the cluster
</span></span><span class=line><span class=cl><span class=o>[</span>bootstrap-token<span class=o>]</span> Creating the <span class=s2>&#34;cluster-info&#34;</span> ConfigMap in the <span class=s2>&#34;kube-public&#34;</span> namespace
</span></span><span class=line><span class=cl><span class=o>[</span>addons<span class=o>]</span> Applied essential addon: CoreDNS
</span></span><span class=line><span class=cl><span class=o>[</span>addons<span class=o>]</span> Applied essential addon: kube-proxy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Your Kubernetes control-plane has initialized successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join 10.64.144.100:6443 --token d7cb0e.605fb37fed0895d3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --discovery-token-ca-cert-hash sha256:dcabbe4b86492eb5da1f22c2a24fb1b5698557185abd481d858eda25a8d926aa
</span></span></code></pre></div><p>如上提示有三条信息</p><ul><li>需要配置 kubeconfig ,以便 kubectl 可以操作集群</li><li>需要选择一个网络插件进行安装，以使集群可以连接网络通信</li><li>保存最后一条命令，后续 worker 节点加入集群时会用到</li></ul><h3 id=配置-kubeconfig>配置 kubeconfig<a hidden class=anchor aria-hidden=true href=#配置-kubeconfig>#</a></h3><p>按上面提示操作就行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><p>使用 kubectl 查看集群当前状态，顺便检验 kubeconfig 是否配置正确</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -n kube-system <span class=c1># 查看系统组件运行状态</span>
</span></span><span class=line><span class=cl>NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>coredns-67c766df46-5d5pp             0/1     Pending   <span class=m>0</span>          4m40s
</span></span><span class=line><span class=cl>coredns-67c766df46-kjd9f             0/1     Pending   <span class=m>0</span>          4m40s
</span></span><span class=line><span class=cl>etcd-k8s-master                      1/1     Running   <span class=m>0</span>          3m34s
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master            1/1     Running   <span class=m>0</span>          3m41s
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master   1/1     Running   <span class=m>0</span>          3m44s
</span></span><span class=line><span class=cl>kube-proxy-r2w74                     1/1     Running   <span class=m>0</span>          4m39s
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master            1/1     Running   <span class=m>0</span>          3m44s
</span></span><span class=line><span class=cl>$ kubectl get nodes  <span class=c1># 查看节点状态</span>
</span></span><span class=line><span class=cl>NAME         STATUS     ROLES    AGE    VERSION
</span></span><span class=line><span class=cl>k8s-master   NotReady   master   5m6s   v1.16.3
</span></span></code></pre></div><p>以上两个 coredns 的 pod 处于 Pending 状态，以及 master 节点 NotReady 状态，是由于我们集群中还没有安装可通信的网络插件，暂时先忽略即可</p><h2 id=加入-worker-节点到集群>加入 worker 节点到集群<a hidden class=anchor aria-hidden=true href=#加入-worker-节点到集群>#</a></h2><blockquote><p>在 woker 节点上操作</p></blockquote><p>还记得<code>kubeadm init</code>后输出的最后一条命令吗，worker 节点上只需要执行这一条命令就行了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm join 10.64.144.100:6443 --token d7cb0e.605fb37fed0895d3 --discovery-token-ca-cert-hash sha256:dcabbe4b86492eb5da1f22c2a24fb1b5698557185abd481d858eda25a8d926aa
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> Running pre-flight checks
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> Reading configuration from the cluster...
</span></span><span class=line><span class=cl><span class=o>[</span>preflight<span class=o>]</span> FYI: You can look at this config file with <span class=s1>&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Downloading configuration <span class=k>for</span> the kubelet from the <span class=s2>&#34;kubelet-config-1.16&#34;</span> ConfigMap in the kube-system namespace
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Writing kubelet configuration to file <span class=s2>&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Writing kubelet environment file with flags to file <span class=s2>&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Activating the kubelet service
</span></span><span class=line><span class=cl><span class=o>[</span>kubelet-start<span class=o>]</span> Waiting <span class=k>for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This node has joined the cluster:
</span></span><span class=line><span class=cl>* Certificate signing request was sent to apiserver and a response was received.
</span></span><span class=line><span class=cl>* The Kubelet was informed of the new secure connection details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Run <span class=s1>&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</span></span></code></pre></div><blockquote><p>master 节点上操作</p></blockquote><p>所有节点上都执行后，在 master 上查看节点状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get nodes
</span></span><span class=line><span class=cl>NAME         STATUS     ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>k8s-master   NotReady   master   18m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node01   NotReady   &lt;none&gt;   57s   v1.16.3
</span></span><span class=line><span class=cl>k8s-node02   NotReady   &lt;none&gt;   20s   v1.16.3
</span></span><span class=line><span class=cl>k8s-node03   NotReady   &lt;none&gt;   9s    v1.16.3
</span></span><span class=line><span class=cl>k8s-node04   NotReady   &lt;none&gt;   2s    v1.16.3
</span></span><span class=line><span class=cl>k8s-node05   NotReady   &lt;none&gt;   2s    v1.16.3
</span></span><span class=line><span class=cl>k8s-node06   NotReady   &lt;none&gt;   2s    v1.16.3
</span></span></code></pre></div><p>到目前为止，我们集群已经创建好的，但是节点间还不能相互通信，所以状态都还是<code>NotReady</code></p><p>接下来我们将选择一款适合自己的网络插件来部署</p><h2 id=安装-cni-网络插件>安装 CNI 网络插件<a hidden class=anchor aria-hidden=true href=#安装-cni-网络插件>#</a></h2><blockquote><p>所有操作均在 master 节点上</p></blockquote><p>注意事项及支持的网络插件列表请参考官网 <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network>Installing a pod network add-on</a> 及 <a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy>Networking and Network Policy</a></p><p>关于各 CNI 插件的功能对比可以参考 <a href=https://blog.csdn.net/RancherLabs/article/details/88885539>Kubernetes CNI 网络最强对比：Flannel、Calico、Canal 和 Weave</a> 和性能基准测试 <a href=https://zhuanlan.zhihu.com/p/53296042>K8S 网络插件（CNI）超过 10Gbit/s 的基准测试结果</a></p><p>由于我们实验环境是二层可达，所以选用 Calico BGP 模式，如果二层不可达，可以考虑使用 Calico IPIP 或者 Flannel VXLAN</p><h3 id=下载-calicoyaml>下载 calico.yaml<a hidden class=anchor aria-hidden=true href=#下载-calicoyaml>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -O https://docs.projectcalico.org/manifests/calico.yaml
</span></span></code></pre></div><p>默认情况下，不做修改也可以，calico 会自动发现 cluster cidr, 这里我们自行修改下</p><p>主要改动如下:</p><ul><li><code>CALICO_IPV4POOL_IPIP</code> 设置为 <code>Never</code>，关闭 IPIP 模式</li><li><code>CALICO_IPV4POOL_CIDR</code> 设置为 <code>172.16.0.0/16</code>，对应 kubeadm 中的 <code>cluster-cidr</code></li></ul><h3 id=部署>部署<a hidden class=anchor aria-hidden=true href=#部署>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f caclico.yml
</span></span></code></pre></div><h3 id=通过-calicoctl-查看-bgp-节点状态>通过 calicoctl 查看 BGP 节点状态<a hidden class=anchor aria-hidden=true href=#通过-calicoctl-查看-bgp-节点状态>#</a></h3><p>calicoctl 可以支持通过直接操作 <code>etcd</code> 或者对接 kubernetes apiserver 两种数据源，我这里使用 kubernetes 方式</p><p>具体的安装及配置方式请参考官网 <a href=https://docs.projectcalico.org/getting-started/clis/calicoctl/install>Install calicoctl</a> 与 <a href=https://docs.projectcalico.org/getting-started/clis/calicoctl/configure/overview>Configure calicoctl</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>CALICO_DATASTORE_TYPE</span><span class=o>=</span>kubernetes
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>CALICO_KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>$ calicoctl node status
</span></span><span class=line><span class=cl>Calico process is running.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IPv4 BGP status
</span></span><span class=line><span class=cl>+---------------+-------------------+-------+----------+-------------+
</span></span><span class=line><span class=cl><span class=p>|</span> PEER ADDRESS  <span class=p>|</span>     PEER TYPE     <span class=p>|</span> STATE <span class=p>|</span>  SINCE   <span class=p>|</span>    INFO     <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------+-------------------+-------+----------+-------------+
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.101 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:11:48 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.102 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:10:48 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.103 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:08:10 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.104 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:22:31 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.105 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:22:31 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 10.64.144.106 <span class=p>|</span> node-to-node mesh <span class=p>|</span> up    <span class=p>|</span> 18:07:43 <span class=p>|</span> Established <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------+-------------------+-------+----------+-------------+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IPv6 BGP status
</span></span><span class=line><span class=cl>No IPv6 peers found.
</span></span></code></pre></div><h3 id=确认查看集群状态>确认查看集群状态<a hidden class=anchor aria-hidden=true href=#确认查看集群状态>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -n kube-system
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-kube-controllers-7d4d547dd6-qr98t   1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-8d8bm                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-hlv2h                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-nbt4b                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-p4s45                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-srb88                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>calico-node-vfpfv                          1/1     Running   <span class=m>0</span>          22s
</span></span><span class=line><span class=cl>coredns-67c766df46-5d5pp                   1/1     Running   <span class=m>0</span>          15m
</span></span><span class=line><span class=cl>coredns-67c766df46-kjd9f                   1/1     Running   <span class=m>0</span>          15m
</span></span><span class=line><span class=cl>etcd-k8s-master                            1/1     Running   <span class=m>0</span>          15m
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master                  1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master         1/1     Running   <span class=m>0</span>          15m
</span></span><span class=line><span class=cl>kube-proxy-5tx57                           1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>kube-proxy-6zvzv                           1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>kube-proxy-hv8zt                           1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>kube-proxy-rfsjl                           1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>kube-proxy-tm7jz                           1/1     Running   <span class=m>0</span>          15m
</span></span><span class=line><span class=cl>kube-proxy-kkssc                           1/1     Running   <span class=m>0</span>          13m
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master                  1/1     Running   <span class=m>0</span>          14m
</span></span><span class=line><span class=cl>$ kubectl get nodes
</span></span><span class=line><span class=cl>NAME         STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>k8s-master   Ready    master   16m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node01   Ready    &lt;none&gt;   14m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node02   Ready    &lt;none&gt;   14m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node03   Ready    &lt;none&gt;   14m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node04   Ready    &lt;none&gt;   14m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node05   Ready    &lt;none&gt;   15m   v1.16.3
</span></span><span class=line><span class=cl>k8s-node06   Ready    &lt;none&gt;   14m   v1.16.3
</span></span></code></pre></div><p>此时可以发现所有节点已经是 Ready 状态，且 coredns 也已经正常 Running</p><h2 id=配置节点之间流量加密-可选>配置节点之间流量加密 (可选)<a hidden class=anchor aria-hidden=true href=#配置节点之间流量加密-可选>#</a></h2><blockquote><p>所有节点上操作</p></blockquote><p>calico 支持通过 <code>WireGuard</code> 对节点之间的流量进行加密传输(仅支持 BGP 模式)</p><blockquote><p>目前处于 preview 状态，不可用于生产环境</p></blockquote><p>安装 WireGuard 可参考 <a href=https://www.wireguard.com/install/>WireGuard Installation</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install epel-release https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm
</span></span><span class=line><span class=cl>yum install yum-plugin-elrepo
</span></span><span class=line><span class=cl>yum install kmod-wireguard wireguard-tools
</span></span></code></pre></div><p>加载 WireGuard 内核模块</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ modprobe wireguard
</span></span><span class=line><span class=cl>$ lsmod <span class=p>|</span> grep wireguard
</span></span><span class=line><span class=cl>wireguard              <span class=m>86016</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>curve25519_x86_64      <span class=m>40960</span>  <span class=m>1</span> wireguard
</span></span><span class=line><span class=cl>libchacha20poly1305    <span class=m>16384</span>  <span class=m>1</span> wireguard
</span></span><span class=line><span class=cl>ip6_udp_tunnel         <span class=m>16384</span>  <span class=m>1</span> wireguard
</span></span><span class=line><span class=cl>udp_tunnel             <span class=m>16384</span>  <span class=m>1</span> wireguard
</span></span><span class=line><span class=cl>libblake2s             <span class=m>16384</span>  <span class=m>1</span> wireguard
</span></span><span class=line><span class=cl>libcurve25519_generic    <span class=m>53248</span>  <span class=m>2</span> curve25519_x86_64,wireguard
</span></span></code></pre></div><p>添加模块开机自动加载</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; /etc/sysconfig/modules/wireguard.modules <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>/sbin/modinfo -F filename wireguard &gt; /dev/null 2&gt;&amp;1
</span></span></span><span class=line><span class=cl><span class=s>if [ $? -eq 0 ]; then
</span></span></span><span class=line><span class=cl><span class=s>    /sbin/modprobe wireguard
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>$ chmod +x wireguard.modules
</span></span></code></pre></div><p>修改配置开启 wireguard 功能</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ calicoctl patch felixconfiguration default --type<span class=o>=</span><span class=s1>&#39;merge&#39;</span> -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;wireguardEnabled&#34;:true}}&#39;</span>
</span></span><span class=line><span class=cl>Successfully patched <span class=m>1</span> <span class=s1>&#39;FelixConfiguration&#39;</span> resource
</span></span></code></pre></div><p>查看节点状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ calicoctl get node k8s-master -oyaml
</span></span><span class=line><span class=cl>apiVersion: projectcalico.org/v3
</span></span><span class=line><span class=cl>kind: Node
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl>status:
</span></span><span class=line><span class=cl>  wireguardPublicKey: 1OP5d3RVhBK7FE9tJ6l+eG38isdiy3LHzfqPzBSwI34<span class=o>=</span>
</span></span></code></pre></div><h2 id=测试>测试<a hidden class=anchor aria-hidden=true href=#测试>#</a></h2><h3 id=创建-pod-测试集群是否能正常工作>创建 pod 测试集群是否能正常工作<a hidden class=anchor aria-hidden=true href=#创建-pod-测试集群是否能正常工作>#</a></h3><p>尝试创建名为 busybox 的 pod</p><blockquote><p>由于 1.28 以上版本的 busybox 镜像，使用 nslookup 的时候有些 bug 导致不能解析域名，此处使用官方提供提供的 1.28 版本 busybox 的 pod 配置</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/admin/dns/busybox.yaml
</span></span><span class=line><span class=cl>pod/busybox created
</span></span></code></pre></div><h3 id=测试-coredns-能否正常工作>测试 coredns 能否正常工作<a hidden class=anchor aria-hidden=true href=#测试-coredns-能否正常工作>#</a></h3><p>在 busybox pod 中测试</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it busybox -- nslookup kubernetes.default.svc.cluster.local
</span></span><span class=line><span class=cl>Server:    10.96.0.10
</span></span><span class=line><span class=cl>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:      kubernetes.default.svc.cluster.local
</span></span><span class=line><span class=cl>Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</span></span></code></pre></div><p>在节点中使用 dig 命令测试</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ dig kubernetes.default.svc.cluster.local @10.96.0.10
</span></span><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-9.P2.el7 &lt;&lt;&gt;&gt; kubernetes.default.svc.cluster.local @10.96.0.10
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;;</span> Got answer:
</span></span><span class=line><span class=cl><span class=p>;;</span> WARNING: .local is reserved <span class=k>for</span> Multicast DNS
</span></span><span class=line><span class=cl><span class=p>;;</span> You are currently testing what happens when an mDNS query is leaked to DNS
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>56913</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags: qr aa rd<span class=p>;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WARNING: recursion requested but not available
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> OPT PSEUDOSECTION:
</span></span><span class=line><span class=cl><span class=p>;</span> EDNS: version: 0, flags:<span class=p>;</span> udp: <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> QUESTION SECTION:
</span></span><span class=line><span class=cl><span class=p>;</span>kubernetes.default.svc.cluster.local. IN A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> ANSWER SECTION:
</span></span><span class=line><span class=cl>kubernetes.default.svc.cluster.local. <span class=m>14</span> IN A   10.96.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> Query time: <span class=m>1</span> msec
</span></span><span class=line><span class=cl><span class=p>;;</span> SERVER: 10.96.0.10#53<span class=o>(</span>10.96.0.10<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WHEN: Fri Nov <span class=m>22</span> 12:21:58 CST <span class=m>2019</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> MSG SIZE  rcvd: <span class=m>117</span>
</span></span></code></pre></div><h2 id=安装-ingress>安装 Ingress<a hidden class=anchor aria-hidden=true href=#安装-ingress>#</a></h2><p>配置文件参考官方 <a href=https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/mandatory.yaml>mandatory.yaml</a></p><p>不过官方是使用 <code>Deployment</code> 来部署的，我这里改成了 <code>DaemonSet</code> 方式，同时补上了 <code>Service</code> 的部分</p><p>完整配置如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; ingress-nginx.yaml <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Namespace
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-configuration
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: tcp-services
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: udp-services
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ServiceAccount
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-serviceaccount
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-clusterrole
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>rules:
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - configmaps
</span></span></span><span class=line><span class=cl><span class=s>      - endpoints
</span></span></span><span class=line><span class=cl><span class=s>      - nodes
</span></span></span><span class=line><span class=cl><span class=s>      - pods
</span></span></span><span class=line><span class=cl><span class=s>      - secrets
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - list
</span></span></span><span class=line><span class=cl><span class=s>      - watch
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - nodes
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - services
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>      - list
</span></span></span><span class=line><span class=cl><span class=s>      - watch
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - events
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - create
</span></span></span><span class=line><span class=cl><span class=s>      - patch
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;extensions&#34;
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;networking.k8s.io&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - ingresses
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>      - list
</span></span></span><span class=line><span class=cl><span class=s>      - watch
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;extensions&#34;
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;networking.k8s.io&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - ingresses/status
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - update
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Role
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-role
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>rules:
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - configmaps
</span></span></span><span class=line><span class=cl><span class=s>      - pods
</span></span></span><span class=line><span class=cl><span class=s>      - secrets
</span></span></span><span class=line><span class=cl><span class=s>      - namespaces
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - configmaps
</span></span></span><span class=line><span class=cl><span class=s>    resourceNames:
</span></span></span><span class=line><span class=cl><span class=s>      # Defaults to &#34;&lt;election-id&gt;-&lt;ingress-class&gt;&#34;
</span></span></span><span class=line><span class=cl><span class=s>      # Here: &#34;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&#34;
</span></span></span><span class=line><span class=cl><span class=s>      # This has to be adapted if you change either parameter
</span></span></span><span class=line><span class=cl><span class=s>      # when launching the nginx-ingress-controller.
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;ingress-controller-leader-nginx&#34;
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>      - update
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - configmaps
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - create
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - endpoints
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - get
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: RoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-role-nisa-binding
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: Role
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-role
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>  - kind: ServiceAccount
</span></span></span><span class=line><span class=cl><span class=s>    name: nginx-ingress-serviceaccount
</span></span></span><span class=line><span class=cl><span class=s>    namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-clusterrole-nisa-binding
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-clusterrole
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>  - kind: ServiceAccount
</span></span></span><span class=line><span class=cl><span class=s>    name: nginx-ingress-serviceaccount
</span></span></span><span class=line><span class=cl><span class=s>    namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: DaemonSet
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-controller
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>      app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>        app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>      annotations:
</span></span></span><span class=line><span class=cl><span class=s>        prometheus.io/port: &#34;10254&#34;
</span></span></span><span class=line><span class=cl><span class=s>        prometheus.io/scrape: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      # wait up to five minutes for the drain of connections
</span></span></span><span class=line><span class=cl><span class=s>      terminationGracePeriodSeconds: 300
</span></span></span><span class=line><span class=cl><span class=s>      serviceAccountName: nginx-ingress-serviceaccount
</span></span></span><span class=line><span class=cl><span class=s>      nodeSelector:
</span></span></span><span class=line><span class=cl><span class=s>        kubernetes.io/os: linux
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>        - name: nginx-ingress-controller
</span></span></span><span class=line><span class=cl><span class=s>          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.26.1
</span></span></span><span class=line><span class=cl><span class=s>          args:
</span></span></span><span class=line><span class=cl><span class=s>            - /nginx-ingress-controller
</span></span></span><span class=line><span class=cl><span class=s>            - --configmap=$(POD_NAMESPACE)/nginx-configuration
</span></span></span><span class=line><span class=cl><span class=s>            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
</span></span></span><span class=line><span class=cl><span class=s>            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
</span></span></span><span class=line><span class=cl><span class=s>            - --publish-service=$(POD_NAMESPACE)/ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>            - --annotations-prefix=nginx.ingress.kubernetes.io
</span></span></span><span class=line><span class=cl><span class=s>          securityContext:
</span></span></span><span class=line><span class=cl><span class=s>            allowPrivilegeEscalation: true
</span></span></span><span class=line><span class=cl><span class=s>            capabilities:
</span></span></span><span class=line><span class=cl><span class=s>              drop:
</span></span></span><span class=line><span class=cl><span class=s>                - ALL
</span></span></span><span class=line><span class=cl><span class=s>              add:
</span></span></span><span class=line><span class=cl><span class=s>                - NET_BIND_SERVICE
</span></span></span><span class=line><span class=cl><span class=s>            # www-data -&gt; 33
</span></span></span><span class=line><span class=cl><span class=s>            runAsUser: 33
</span></span></span><span class=line><span class=cl><span class=s>          env:
</span></span></span><span class=line><span class=cl><span class=s>            - name: POD_NAME
</span></span></span><span class=line><span class=cl><span class=s>              valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>                fieldRef:
</span></span></span><span class=line><span class=cl><span class=s>                  fieldPath: metadata.name
</span></span></span><span class=line><span class=cl><span class=s>            - name: POD_NAMESPACE
</span></span></span><span class=line><span class=cl><span class=s>              valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>                fieldRef:
</span></span></span><span class=line><span class=cl><span class=s>                  fieldPath: metadata.namespace
</span></span></span><span class=line><span class=cl><span class=s>          ports:
</span></span></span><span class=line><span class=cl><span class=s>            - name: http
</span></span></span><span class=line><span class=cl><span class=s>              containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>            - name: https
</span></span></span><span class=line><span class=cl><span class=s>              containerPort: 443
</span></span></span><span class=line><span class=cl><span class=s>          livenessProbe:
</span></span></span><span class=line><span class=cl><span class=s>            failureThreshold: 3
</span></span></span><span class=line><span class=cl><span class=s>            httpGet:
</span></span></span><span class=line><span class=cl><span class=s>              path: /healthz
</span></span></span><span class=line><span class=cl><span class=s>              port: 10254
</span></span></span><span class=line><span class=cl><span class=s>              scheme: HTTP
</span></span></span><span class=line><span class=cl><span class=s>            initialDelaySeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>            periodSeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>            successThreshold: 1
</span></span></span><span class=line><span class=cl><span class=s>            timeoutSeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          readinessProbe:
</span></span></span><span class=line><span class=cl><span class=s>            failureThreshold: 3
</span></span></span><span class=line><span class=cl><span class=s>            httpGet:
</span></span></span><span class=line><span class=cl><span class=s>              path: /healthz
</span></span></span><span class=line><span class=cl><span class=s>              port: 10254
</span></span></span><span class=line><span class=cl><span class=s>              scheme: HTTP
</span></span></span><span class=line><span class=cl><span class=s>            periodSeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>            successThreshold: 1
</span></span></span><span class=line><span class=cl><span class=s>            timeoutSeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          lifecycle:
</span></span></span><span class=line><span class=cl><span class=s>            preStop:
</span></span></span><span class=line><span class=cl><span class=s>              exec:
</span></span></span><span class=line><span class=cl><span class=s>                command:
</span></span></span><span class=line><span class=cl><span class=s>                  - /wait-shutdown
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-ingress-controller
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  type: LoadBalancer
</span></span></span><span class=line><span class=cl><span class=s>  externalTrafficPolicy: Local
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/part-of: ingress-nginx
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>    - name: http
</span></span></span><span class=line><span class=cl><span class=s>      port: 80
</span></span></span><span class=line><span class=cl><span class=s>      protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>      targetPort: 80
</span></span></span><span class=line><span class=cl><span class=s>    - name: https
</span></span></span><span class=line><span class=cl><span class=s>      port: 443
</span></span></span><span class=line><span class=cl><span class=s>      protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>      targetPort: 443
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>部署</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f ingress-nginx.yaml  <span class=c1># 执行部署</span>
</span></span><span class=line><span class=cl>namespace/ingress-nginx created
</span></span><span class=line><span class=cl>configmap/nginx-configuration created
</span></span><span class=line><span class=cl>configmap/tcp-services created
</span></span><span class=line><span class=cl>configmap/udp-services created
</span></span><span class=line><span class=cl>serviceaccount/nginx-ingress-serviceaccount created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole created
</span></span><span class=line><span class=cl>role.rbac.authorization.k8s.io/nginx-ingress-role created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-binding created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding created
</span></span><span class=line><span class=cl>daemonset.apps/nginx-ingress-controller created
</span></span><span class=line><span class=cl>service/nginx-ingress-controller created
</span></span><span class=line><span class=cl>$ kubectl get pods -n ingress-nginx  <span class=c1># 查看pod运行状态</span>
</span></span><span class=line><span class=cl>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>nginx-ingress-controller-2hc8m   1/1     Running   <span class=m>0</span>          4m36s
</span></span><span class=line><span class=cl>nginx-ingress-controller-69rfm   1/1     Running   <span class=m>0</span>          4m36s
</span></span><span class=line><span class=cl>nginx-ingress-controller-ps7gt   1/1     Running   <span class=m>0</span>          4m36s
</span></span><span class=line><span class=cl>nginx-ingress-controller-zfq56   1/1     Running   <span class=m>0</span>          4m36s
</span></span><span class=line><span class=cl>$ kubectl get service -n ingress-nginx  <span class=c1># 查看service状态</span>
</span></span><span class=line><span class=cl>NAME                       TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>                      AGE
</span></span><span class=line><span class=cl>nginx-ingress-controller   LoadBalancer   10.96.76.163   &lt;pending&gt;     80:31832/TCP,443:30219/TCP   6m10s
</span></span></code></pre></div><p>此时发现 pod 已经正常运行了，但是 service 的 EXTERNAL-IP 字段却是 pending 状态</p><p>这是由于我们集群中还没有能处理 <code>LoadBalancer</code> 类型 service 的程序</p><p>在云环境中都会有个额外的组件 <code>Cloud-Controller-Manager(CCM)</code> 来对接云平台的负载均衡服务，如阿里云的 SLB，AWS 的 ALB 等</p><p>那么线下环境有没有办法实现类似 CCM 的功能呢，答案是 <code>metallb</code></p><h2 id=部署-metallb>部署 Metallb<a hidden class=anchor aria-hidden=true href=#部署-metallb>#</a></h2><p>metallb 是一款为祼机 Kubernetes 环境提供标准路由协议的开源软负载均衡器，支持基于二层网络 ARP 或基于 BGP 方式进行地址广播</p><p>更详细的介绍请参考<a href=https://metallb.universe.tf/>官方文档</a>或<a href=https://github.com/danderson/metallb>Github</a></p><p>关于裸机下基于 Metallb 的负载均衡方案可参考 ingress-nginx 官方文档 <a href=https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb>A pure software solution: MetalLB</a></p><p>由于当前的物理环境中不支持 BGP，所以使用最简单的二层 ARP 方式</p><p>部署:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.8.3/manifests/metallb.yaml
</span></span><span class=line><span class=cl>namespace/metallb-system created
</span></span><span class=line><span class=cl>podsecuritypolicy.policy/speaker created
</span></span><span class=line><span class=cl>serviceaccount/controller created
</span></span><span class=line><span class=cl>serviceaccount/speaker created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
</span></span><span class=line><span class=cl>role.rbac.authorization.k8s.io/config-watcher created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/config-watcher created
</span></span><span class=line><span class=cl>daemonset.apps/speaker created
</span></span><span class=line><span class=cl>deployment.apps/controller created
</span></span><span class=line><span class=cl>$ kubectl get pods -n metallb-system
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>controller-65895b47d4-fbs7t   1/1     Running   <span class=m>0</span>          3m21s
</span></span><span class=line><span class=cl>speaker-2skdk                 1/1     Running   <span class=m>0</span>          3m21s
</span></span><span class=line><span class=cl>speaker-6mg76                 1/1     Running   <span class=m>0</span>          3m21s
</span></span><span class=line><span class=cl>speaker-7rr8q                 1/1     Running   <span class=m>0</span>          3m21s
</span></span><span class=line><span class=cl>speaker-dv2rh                 1/1     Running   <span class=m>0</span>          3m21s
</span></span><span class=line><span class=cl>speaker-mwkqr                 1/1     Running   <span class=m>0</span>          3m21s
</span></span></code></pre></div><p>创建配置文件</p><p>addresses 表示 LoadBalancer 可使用的 IP 池范围</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; metallb-configmap.yaml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>  name: config
</span></span></span><span class=line><span class=cl><span class=s>data:
</span></span></span><span class=line><span class=cl><span class=s>  config: |
</span></span></span><span class=line><span class=cl><span class=s>    address-pools:
</span></span></span><span class=line><span class=cl><span class=s>    - name: default
</span></span></span><span class=line><span class=cl><span class=s>      protocol: layer2
</span></span></span><span class=line><span class=cl><span class=s>      addresses:
</span></span></span><span class=line><span class=cl><span class=s>      - 10.64.144.150-10.64.144.250
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>$ kubectl apply -f metallb-configmap.yaml
</span></span><span class=line><span class=cl>configmap/config created
</span></span></code></pre></div><p>而此时再去查看 ingree-nginx 的 service 可以发现已经 EXTERNAL-IP 字段已经能正常拿到 IP 了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get service -n ingress-nginx
</span></span><span class=line><span class=cl>NAME                       TYPE           CLUSTER-IP     EXTERNAL-IP     PORT<span class=o>(</span>S<span class=o>)</span>                      AGE
</span></span><span class=line><span class=cl>nginx-ingress-controller   LoadBalancer   10.96.76.163   10.64.144.150   80:31832/TCP,443:30219/TCP   50m
</span></span></code></pre></div><h2 id=测试-ingress-nginx-及-metallb>测试 ingress-nginx 及 metallb<a hidden class=anchor aria-hidden=true href=#测试-ingress-nginx-及-metallb>#</a></h2><p>前面已经创建了 ingress-nginx 及 metallb,但到目前为止也只是看到了集群中的状态，并不能说明它俩是真的可用</p><p>所以我们来创建一个简单的应用来测试下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; nginx-test.yaml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  creationTimestamp: null
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 80
</span></span></span><span class=line><span class=cl><span class=s>    name: http
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    run: nginx
</span></span></span><span class=line><span class=cl><span class=s>status:
</span></span></span><span class=line><span class=cl><span class=s>  loadBalancer: {}
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  creationTimestamp: null
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: nginx
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 1
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: nginx
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      creationTimestamp: null
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - image: nginx:alpine
</span></span></span><span class=line><span class=cl><span class=s>        name: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Ingress
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - host: test.nginx.com
</span></span></span><span class=line><span class=cl><span class=s>    http:
</span></span></span><span class=line><span class=cl><span class=s>      paths:
</span></span></span><span class=line><span class=cl><span class=s>      - path: /
</span></span></span><span class=line><span class=cl><span class=s>        backend:
</span></span></span><span class=line><span class=cl><span class=s>          serviceName: nginx
</span></span></span><span class=line><span class=cl><span class=s>          servicePort: http
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>$ kubectl apply -f nginx-test.yaml
</span></span><span class=line><span class=cl>service/nginx created
</span></span><span class=line><span class=cl>deployment.apps/nginx created
</span></span><span class=line><span class=cl>ingress.networking.k8s.io/nginx created
</span></span><span class=line><span class=cl>$ curl -H <span class=s1>&#39;Host: test.nginx.com&#39;</span> http://10.64.144.150 <span class=c1># 在局域网中其他机器测试访问</span>
</span></span><span class=line><span class=cl>&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class=line><span class=cl>&lt;style&gt;
</span></span><span class=line><span class=cl>    body <span class=o>{</span>
</span></span><span class=line><span class=cl>        width: 35em<span class=p>;</span>
</span></span><span class=line><span class=cl>        margin: <span class=m>0</span> auto<span class=p>;</span>
</span></span><span class=line><span class=cl>        font-family: Tahoma, Verdana, Arial, sans-serif<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>&lt;/style&gt;
</span></span><span class=line><span class=cl>&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class=line><span class=cl>working. Further configuration is required.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;For online documentation and support please refer to
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class=line><span class=cl>Commercial support is available at
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;&lt;em&gt;Thank you <span class=k>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></div><p>由此 ingress-nginx 及负载均衡器 Metallb 已经部署完成</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxyunwei.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://linuxyunwei.com/posts/kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4/><span class=title>«</span><br><span>使用Kubeadm更新集群</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on x" href="https://x.com/intent/tweet/?text=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4&amp;url=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f&amp;hashtags=kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f&amp;title=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4&amp;summary=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4&amp;source=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f&title=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on whatsapp" href="https://api.whatsapp.com/send?text=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4%20-%20https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on telegram" href="https://telegram.me/share/url?text=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4&amp;url=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share kubeadm 安装单master集群 on ycombinator" href="https://news.ycombinator.com/submitlink?t=kubeadm%20%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4&u=https%3a%2f%2flinuxyunwei.com%2fposts%2fkubeadm-%25E5%25AE%2589%25E8%25A3%2585%25E5%258D%2595master%25E9%259B%2586%25E7%25BE%25A4%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>戴先森 · <a rel="license noopener" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a> <a href=http://www.miitbeian.gov.cn/ target=_blank>沪ICP备13017200号-1</a> <a target=_blank rel=noreferrer href="https://beian.mps.gov.cn/#/query/webSearch?code=31011702890206">沪公网安备31011702890206号</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>