<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>使用Kubeadm更新集群 - 戴先森的学习笔记</title><meta name="Description" content="戴先森的学习笔记"><meta property="og:title" content="使用Kubeadm更新集群" />
<meta property="og:description" content="前面我们已经通过 kubeadm 安装了一套集群 当时安装的版本为 v1.16.3，现在版本已经更新到 1.18.x 了，所以我们需要对它进行升级 k8s 不支持跨多个大版本升级，所" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://linuxyunwei.com/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4/" />
<meta property="article:published_time" content="2020-05-20T19:17:26+08:00" />
<meta property="article:modified_time" content="2020-05-20T19:17:26+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Kubeadm更新集群"/>
<meta name="twitter:description" content="前面我们已经通过 kubeadm 安装了一套集群 当时安装的版本为 v1.16.3，现在版本已经更新到 1.18.x 了，所以我们需要对它进行升级 k8s 不支持跨多个大版本升级，所"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://linuxyunwei.com/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4/" /><link rel="prev" href="https://linuxyunwei.com/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "使用Kubeadm更新集群",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/linuxyunwei.com\/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/linuxyunwei.com\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "kubernetes, kubeadm","wordcount":  2922 ,
        "url": "https:\/\/linuxyunwei.com\/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4\/","datePublished": "2020-05-20T19:17:26+08:00","dateModified": "2020-05-20T19:17:26+08:00","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/linuxyunwei.com\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "戴先森"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="戴先森的学习笔记"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> 首页 </a><a class="menu-item" href="/posts/"> 文章列表 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="戴先森的学习笔记"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/" title="">首页</a><a class="menu-item" href="/posts/" title="">文章列表</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">使用Kubeadm更新集群</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>戴先森</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes/"><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-05-20">2020-05-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2922 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#查看可升级的版本">查看可升级的版本</a></li>
    <li><a href="#升级-master">升级 master</a>
      <ul>
        <li><a href="#安装-1175-版本-kubeadm">安装 1.17.5 版本 kubeadm</a></li>
        <li><a href="#给-master-节点打上污点并驱逐所有-pod">给 master 节点打上污点并驱逐所有 pod</a></li>
        <li><a href="#升级前的检查">升级前的检查</a></li>
        <li><a href="#执行升级">执行升级</a></li>
        <li><a href="#解除-master-节点污点">解除 master 节点污点</a></li>
        <li><a href="#升级其他-master-节点">升级其他 master 节点</a></li>
        <li><a href="#升级所有-master-节点的-kubectl-与-kubelet">升级所有 master 节点的 kubectl 与 kubelet</a></li>
        <li><a href="#重启-master-节点-kubelet-服务">重启 master 节点 kubelet 服务</a></li>
        <li><a href="#确认-master-版本">确认 master 版本</a></li>
      </ul>
    </li>
    <li><a href="#升级-worker-节点">升级 worker 节点</a>
      <ul>
        <li><a href="#更新-kubeadm">更新 kubeadm</a></li>
        <li><a href="#给-worker-节点打上污点并驱逐所有-pod">给 worker 节点打上污点并驱逐所有 pod</a></li>
        <li><a href="#升级-woker-节点-kubelet-配置">升级 woker 节点 kubelet 配置</a></li>
        <li><a href="#升级-woker-节点-kubelet-与-kubectl-版本">升级 woker 节点 kubelet 与 kubectl 版本</a></li>
        <li><a href="#重启-kubelet-服务">重启 kubelet 服务</a></li>
        <li><a href="#解除-worker-节点污点">解除 worker 节点污点</a></li>
        <li><a href="#验证-worker-节点版本">验证 worker 节点版本</a></li>
      </ul>
    </li>
    <li><a href="#验证集群状态">验证集群状态</a>
      <ul>
        <li><a href="#检查系统组件">检查系统组件</a></li>
        <li><a href="#测试-dns-功能">测试 DNS 功能</a></li>
        <li><a href="#测试访问集群中的服务">测试访问集群中的服务</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>前面我们已经通过 <a href="/kubeadm-%e5%ae%89%e8%a3%85%e5%8d%95master%e9%9b%86%e7%be%a4/" rel="">kubeadm 安装了一套集群</a></p>
<p>当时安装的版本为 v1.16.3，现在版本已经更新到 1.18.x 了，所以我们需要对它进行升级</p>
<blockquote>
<p>k8s 不支持跨多个大版本升级，所以我们如果想要升级到 1.18.x，就得先升级到 1.17.x 版本</p>
</blockquote>
<p>升级步骤参考官方文档 <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/" target="_blank" rel="noopener noreffer">Upgrading kubeadm clusters</a></p>
<h2 id="查看可升级的版本">查看可升级的版本</h2>
<p>如下可以看到，当前 1.17.5 为最新可升级版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ yum list --showduplicates kubeadm --disableexcludes<span class="o">=</span>kubernetes <span class="p">|</span> grep 1.17
kubeadm.x86_64                       1.17.0-0                        kubernetes
kubeadm.x86_64                       1.17.1-0                        kubernetes
kubeadm.x86_64                       1.17.2-0                        kubernetes
kubeadm.x86_64                       1.17.3-0                        kubernetes
kubeadm.x86_64                       1.17.4-0                        kubernetes
kubeadm.x86_64                       1.17.5-0                        kubernetes
</code></pre></td></tr></table>
</div>
</div><h2 id="升级-master">升级 master</h2>
<h3 id="安装-1175-版本-kubeadm">安装 1.17.5 版本 kubeadm</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ yum install -y kubeadm-1.17.5-0 --disableexcludes<span class="o">=</span>kubernetes
$ kubeadm version
kubeadm version: <span class="p">&amp;</span>version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;17&#34;</span>, GitVersion:<span class="s2">&#34;v1.17.5&#34;</span>, GitCommit:<span class="s2">&#34;e0fccafd69541e3750d460ba0f9743b90336f24f&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2020-04-16T11:41:38Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.13.9&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;linux/amd64&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="给-master-节点打上污点并驱逐所有-pod">给 master 节点打上污点并驱逐所有 pod</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl drain k8s-master --ignore-daemonsets --delete-local-data
node/k8s-master already cordoned
node/k8s-master evicted
</code></pre></td></tr></table>
</div>
</div><h3 id="升级前的检查">升级前的检查</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubeadm upgrade plan
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster...
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
<span class="o">[</span>preflight<span class="o">]</span> Some fatal errors occurred:
	<span class="o">[</span>ERROR CoreDNSUnsupportedPlugins<span class="o">]</span>: there are unsupported plugins in the CoreDNS Corefile
<span class="o">[</span>preflight<span class="o">]</span> If you know what you are doing, you can make a check non-fatal with <span class="sb">`</span>--ignore-preflight-errors<span class="o">=</span>...<span class="sb">`</span>
To see the stack trace of this error execute with --v<span class="o">=</span><span class="m">5</span> or higher
</code></pre></td></tr></table>
</div>
</div><p>如上出现警告信息 <code>[ERROR CoreDNSUnsupportedPlugins]: there are unsupported plugins in the CoreDNS Corefile</code></p>
<p>通过如下命令查看 CoreDNS 的配置文件，如果确认没有问题可以通过参数 <code>--ignore-preflight-errors=CoreDNSUnsupportedPlugins</code>忽略，github 上也有相关<a href="https://github.com/kubernetes/kubernetes/issues/82889" target="_blank" rel="noopener noreffer">issue</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get configmap -n kube-system coredns -oyaml
</code></pre></td></tr></table>
</div>
</div><p>此处选择忽略再次重试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubeadm upgrade plan --ignore-preflight-errors<span class="o">=</span>CoreDNSUnsupportedPlugins
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster...
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
	<span class="o">[</span>WARNING CoreDNSUnsupportedPlugins<span class="o">]</span>: there are unsupported plugins in the CoreDNS Corefile
<span class="o">[</span>upgrade<span class="o">]</span> Making sure the cluster is healthy:
<span class="o">[</span>upgrade<span class="o">]</span> Fetching available versions to upgrade to
<span class="o">[</span>upgrade/versions<span class="o">]</span> Cluster version: v1.16.3
<span class="o">[</span>upgrade/versions<span class="o">]</span> kubeadm version: v1.17.5
I0520 19:40:07.623240    <span class="m">6896</span> version.go:251<span class="o">]</span> remote version is much newer: v1.18.2<span class="p">;</span> falling back to: stable-1.17
<span class="o">[</span>upgrade/versions<span class="o">]</span> Latest stable version: v1.17.5
<span class="o">[</span>upgrade/versions<span class="o">]</span> Latest version in the v1.16 series: v1.16.9

Components that must be upgraded manually after you have upgraded the control plane with <span class="s1">&#39;kubeadm upgrade apply&#39;</span>:
COMPONENT   CURRENT       AVAILABLE
Kubelet     <span class="m">6</span> x v1.16.3   v1.16.9

Upgrade to the latest version in the v1.16 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.16.3   v1.16.9
Controller Manager   v1.16.3   v1.16.9
Scheduler            v1.16.3   v1.16.9
Kube Proxy           v1.16.3   v1.16.9
CoreDNS              1.6.2     1.6.5
Etcd                 3.3.15    3.3.17-0

You can now apply the upgrade by executing the following command:

	kubeadm upgrade apply v1.16.9

_____________________________________________________________________

Components that must be upgraded manually after you have upgraded the control plane with <span class="s1">&#39;kubeadm upgrade apply&#39;</span>:
COMPONENT   CURRENT       AVAILABLE
Kubelet     <span class="m">6</span> x v1.16.3   v1.17.5

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.16.3   v1.17.5
Controller Manager   v1.16.3   v1.17.5
Scheduler            v1.16.3   v1.17.5
Kube Proxy           v1.16.3   v1.17.5
CoreDNS              1.6.2     1.6.5
Etcd                 3.3.15    3.4.3-0

You can now apply the upgrade by executing the following command:

	kubeadm upgrade apply v1.17.5

_____________________________________________________________________
</code></pre></td></tr></table>
</div>
</div><h3 id="执行升级">执行升级</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubeadm upgrade apply v1.17.5 --ignore-preflight-errors<span class="o">=</span>CoreDNSUnsupportedPlugins
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster...
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
	<span class="o">[</span>WARNING CoreDNSUnsupportedPlugins<span class="o">]</span>: there are unsupported plugins in the CoreDNS Corefile
<span class="o">[</span>upgrade<span class="o">]</span> Making sure the cluster is healthy:
<span class="o">[</span>upgrade/version<span class="o">]</span> You have chosen to change the cluster version to <span class="s2">&#34;v1.17.5&#34;</span>
<span class="o">[</span>upgrade/versions<span class="o">]</span> Cluster version: v1.16.3
<span class="o">[</span>upgrade/versions<span class="o">]</span> kubeadm version: v1.17.5
<span class="o">[</span>upgrade/confirm<span class="o">]</span> Are you sure you want to proceed with the upgrade? <span class="o">[</span>y/N<span class="o">]</span>: y
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Will prepull images <span class="k">for</span> components <span class="o">[</span>kube-apiserver kube-controller-manager kube-scheduler etcd<span class="o">]</span>
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulling image <span class="k">for</span> component kube-apiserver.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulling image <span class="k">for</span> component kube-controller-manager.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulling image <span class="k">for</span> component etcd.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulling image <span class="k">for</span> component kube-scheduler.
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-kube-controller-manager
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">0</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-kube-scheduler
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">0</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-etcd
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-kube-apiserver
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-kube-scheduler
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector k8s-app<span class="o">=</span>upgrade-prepull-etcd
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulled image <span class="k">for</span> component kube-apiserver.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulled image <span class="k">for</span> component kube-controller-manager.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulled image <span class="k">for</span> component etcd.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Prepulled image <span class="k">for</span> component kube-scheduler.
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Successfully prepulled the images <span class="k">for</span> all the control plane components
<span class="o">[</span>upgrade/apply<span class="o">]</span> Upgrading your Static Pod-hosted control plane to version <span class="s2">&#34;v1.17.5&#34;</span>...
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-controller-manager-k8s-master hash: 83e58d3548072b341a6faa0bbf8427dc
Static pod: kube-scheduler-k8s-master hash: e8486b59c2c8408b07026a560746b02c
<span class="o">[</span>upgrade/etcd<span class="o">]</span> Upgrading to TLS <span class="k">for</span> etcd
Static pod: etcd-k8s-master hash: 7d86fcdbd639f4fd16605f99fbffa6e4
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Preparing <span class="k">for</span> <span class="s2">&#34;etcd&#34;</span> upgrade
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing etcd-server certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing etcd-peer certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing etcd-healthcheck-client certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Moved new manifest to <span class="s2">&#34;/etc/kubernetes/manifests/etcd.yaml&#34;</span> and backed up old manifest to <span class="s2">&#34;/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-05-20-19-53-29/etcd.yaml&#34;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> This might take a minute or longer depending on the component/version gap <span class="o">(</span>timeout 5m0s<span class="o">)</span>
Static pod: etcd-k8s-master hash: 7d86fcdbd639f4fd16605f99fbffa6e4
Static pod: etcd-k8s-master hash: 0f55aa1d6eb94a8c4eca4c5f027fb643
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector <span class="nv">component</span><span class="o">=</span>etcd
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Component <span class="s2">&#34;etcd&#34;</span> upgraded successfully!
<span class="o">[</span>upgrade/etcd<span class="o">]</span> Waiting <span class="k">for</span> etcd to become available
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Writing new Static Pod manifests to <span class="s2">&#34;/etc/kubernetes/tmp/kubeadm-upgraded-manifests198557268&#34;</span>
W0520 19:54:11.882414   <span class="m">28625</span> manifests.go:214<span class="o">]</span> the default kube-apiserver authorization-mode is <span class="s2">&#34;Node,RBAC&#34;</span><span class="p">;</span> using <span class="s2">&#34;Node,RBAC&#34;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Preparing <span class="k">for</span> <span class="s2">&#34;kube-apiserver&#34;</span> upgrade
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing apiserver certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing apiserver-kubelet-client certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing front-proxy-client certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing apiserver-etcd-client certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Moved new manifest to <span class="s2">&#34;/etc/kubernetes/manifests/kube-apiserver.yaml&#34;</span> and backed up old manifest to <span class="s2">&#34;/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-05-20-19-53-29/kube-apiserver.yaml&#34;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> This might take a minute or longer depending on the component/version gap <span class="o">(</span>timeout 5m0s<span class="o">)</span>
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: e541261a584becf7ccd0ebc447ad6965
Static pod: kube-apiserver-k8s-master hash: cb0329ceca81a08d2613d2eafe96927f
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector <span class="nv">component</span><span class="o">=</span>kube-apiserver
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Component <span class="s2">&#34;kube-apiserver&#34;</span> upgraded successfully!
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Preparing <span class="k">for</span> <span class="s2">&#34;kube-controller-manager&#34;</span> upgrade
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing controller-manager.conf certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Moved new manifest to <span class="s2">&#34;/etc/kubernetes/manifests/kube-controller-manager.yaml&#34;</span> and backed up old manifest to <span class="s2">&#34;/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-05-20-19-53-29/kube-controller-manager.yaml&#34;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> This might take a minute or longer depending on the component/version gap <span class="o">(</span>timeout 5m0s<span class="o">)</span>
Static pod: kube-controller-manager-k8s-master hash: 83e58d3548072b341a6faa0bbf8427dc
Static pod: kube-controller-manager-k8s-master hash: 57f625031b63d8f30d971821233b1d59
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector <span class="nv">component</span><span class="o">=</span>kube-controller-manager
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Component <span class="s2">&#34;kube-controller-manager&#34;</span> upgraded successfully!
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Preparing <span class="k">for</span> <span class="s2">&#34;kube-scheduler&#34;</span> upgrade
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Renewing scheduler.conf certificate
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Moved new manifest to <span class="s2">&#34;/etc/kubernetes/manifests/kube-scheduler.yaml&#34;</span> and backed up old manifest to <span class="s2">&#34;/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-05-20-19-53-29/kube-scheduler.yaml&#34;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> This might take a minute or longer depending on the component/version gap <span class="o">(</span>timeout 5m0s<span class="o">)</span>
Static pod: kube-scheduler-k8s-master hash: e8486b59c2c8408b07026a560746b02c
Static pod: kube-scheduler-k8s-master hash: 9d8e79ec2b72cfad2458fb03205bc653
<span class="o">[</span>apiclient<span class="o">]</span> Found <span class="m">1</span> Pods <span class="k">for</span> label selector <span class="nv">component</span><span class="o">=</span>kube-scheduler
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Component <span class="s2">&#34;kube-scheduler&#34;</span> upgraded successfully!
<span class="o">[</span>upload-config<span class="o">]</span> Storing the configuration used in ConfigMap <span class="s2">&#34;kubeadm-config&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
<span class="o">[</span>kubelet<span class="o">]</span> Creating a ConfigMap <span class="s2">&#34;kubelet-config-1.17&#34;</span> in namespace kube-system with the configuration <span class="k">for</span> the kubelets in the cluster
<span class="o">[</span>kubelet-start<span class="o">]</span> Downloading configuration <span class="k">for</span> the kubelet from the <span class="s2">&#34;kubelet-config-1.17&#34;</span> ConfigMap in the kube-system namespace
<span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span class="k">for</span> nodes to get long term certificate credentials
<span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow certificate rotation <span class="k">for</span> all node client certificates in the cluster
<span class="o">[</span>addons<span class="o">]</span>: Migrating CoreDNS Corefile
<span class="o">[</span>addons<span class="o">]</span> Applied essential addon: CoreDNS
<span class="o">[</span>addons<span class="o">]</span> Applied essential addon: kube-proxy

<span class="o">[</span>upgrade/successful<span class="o">]</span> SUCCESS! Your cluster was upgraded to <span class="s2">&#34;v1.17.5&#34;</span>. Enjoy!

<span class="o">[</span>upgrade/kubelet<span class="o">]</span> Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="k">if</span> you haven<span class="err">&#39;</span>t already <span class="k">done</span> so.
</code></pre></td></tr></table>
</div>
</div><h3 id="解除-master-节点污点">解除 master 节点污点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl uncordon k8s-master
node/k8s-master uncordoned
</code></pre></td></tr></table>
</div>
</div><h3 id="升级其他-master-节点">升级其他 master 节点</h3>
<p>如果是高可用版本还需要升级其他的 master 节点</p>
<blockquote>
<p>本次集群只有单个 master,以下操作纯做记录</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ yum install -y kubeadm-1.17.5-0 --disableexcludes<span class="o">=</span>kubernetes
$ kubeadm upgrade node
$ kubeadm upgrade apply
</code></pre></td></tr></table>
</div>
</div><h3 id="升级所有-master-节点的-kubectl-与-kubelet">升级所有 master 节点的 kubectl 与 kubelet</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ yum install -y kubectl-1.17.5-0 kubelet-1.17.5-0 --disableexcludes<span class="o">=</span>kubernetes
</code></pre></td></tr></table>
</div>
</div><h3 id="重启-master-节点-kubelet-服务">重启 master 节点 kubelet 服务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ systemctl daemon-reload
$ systemctl restart kubelet
$ systemctl status kubelet
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/kubelet.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: active <span class="o">(</span>running<span class="o">)</span> since Wed 2020-05-20 20:11:47 CST<span class="p">;</span> 12s ago
     Docs: https://kubernetes.io/docs/
 Main PID: <span class="m">2904</span> <span class="o">(</span>kubelet<span class="o">)</span>
    Tasks: <span class="m">15</span>
   Memory: 25.9M
   CGroup: /system.slice/kubelet.service
           └─2904 /usr/bin/kubelet --bootstrap-kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span class="o">=</span>/etc/kubernetes/kubelet.conf --config<span class="o">=</span>/var/lib/kubelet/config.yaml --cgroup-driver<span class="o">=</span>systemd --network-plugin<span class="o">=</span>cni --pod-infra...

May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.297946    <span class="m">2904</span> docker_service.go:260<span class="o">]</span> Docker Info: <span class="p">&amp;</span><span class="o">{</span>ID:BI53:OQC7:QV6C:SP3N:FBTT:N5ST:MK3I:CGLJ:X2JX:CJOH:CBEE:4GG2 Containers:30 ContainersRunning:22 Containe...rts d_type true<span class="o">]</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.298023    <span class="m">2904</span> docker_service.go:273<span class="o">]</span> Setting cgroupDriver to systemd
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305372    <span class="m">2904</span> remote_runtime.go:59<span class="o">]</span> parsed scheme: <span class="s2">&#34;&#34;</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305387    <span class="m">2904</span> remote_runtime.go:59<span class="o">]</span> scheme <span class="s2">&#34;&#34;</span> not registered, fallback to default scheme
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305408    <span class="m">2904</span> passthrough.go:48<span class="o">]</span> ccResolverWrapper: sending update to cc: <span class="o">{[{</span>/var/run/dockershim.sock <span class="m">0</span>  &lt;nil&gt;<span class="o">}]</span> &lt;nil&gt;<span class="o">}</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305415    <span class="m">2904</span> clientconn.go:577<span class="o">]</span> ClientConn switching balancer to <span class="s2">&#34;pick_first&#34;</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305433    <span class="m">2904</span> remote_image.go:50<span class="o">]</span> parsed scheme: <span class="s2">&#34;&#34;</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305438    <span class="m">2904</span> remote_image.go:50<span class="o">]</span> scheme <span class="s2">&#34;&#34;</span> not registered, fallback to default scheme
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305446    <span class="m">2904</span> passthrough.go:48<span class="o">]</span> ccResolverWrapper: sending update to cc: <span class="o">{[{</span>/var/run/dockershim.sock <span class="m">0</span>  &lt;nil&gt;<span class="o">}]</span> &lt;nil&gt;<span class="o">}</span>
May <span class="m">20</span> 20:11:47 k8s-master kubelet<span class="o">[</span>2904<span class="o">]</span>: I0520 20:11:47.305450    <span class="m">2904</span> clientconn.go:577<span class="o">]</span> ClientConn switching balancer to <span class="s2">&#34;pick_first&#34;</span>
Hint: Some lines were ellipsized, use -l to show in full.
</code></pre></td></tr></table>
</div>
</div><h3 id="确认-master-版本">确认 master 版本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get node k8s-master
NAME         STATUS   ROLES    AGE    VERSION
k8s-master   Ready    master   180d   v1.17.5
</code></pre></td></tr></table>
</div>
</div><h2 id="升级-worker-节点">升级 worker 节点</h2>
<blockquote>
<p>非特别说明，都是在 worker 节点上操作</p>
</blockquote>
<p>需要在所有 woker 节点上进行操作, 此处以 k8s-node01 节点为例</p>
<h3 id="更新-kubeadm">更新 kubeadm</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">yum install -y kubeadm-1.17.5-0 --disableexcludes<span class="o">=</span>kubernetes
</code></pre></td></tr></table>
</div>
</div><h3 id="给-worker-节点打上污点并驱逐所有-pod">给 worker 节点打上污点并驱逐所有 pod</h3>
<blockquote>
<p>在 Master 节点上执行</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl drain k8s-node01 --ignore-daemonsets --delete-local-data
node/k8s-node01 cordoned
evicting pod <span class="s2">&#34;tekton-pipelines-webhook-694dc67fbb-kjbqv&#34;</span>
...
pod/tekton-pipelines-webhook-694dc67fbb-kjbqv evicted
...
node/k8s-node01 evicted
</code></pre></td></tr></table>
</div>
</div><h3 id="升级-woker-节点-kubelet-配置">升级 woker 节点 kubelet 配置</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubeadm upgrade node
<span class="o">[</span>upgrade<span class="o">]</span> Reading configuration from the cluster...
<span class="o">[</span>upgrade<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span class="o">[</span>upgrade<span class="o">]</span> Skipping phase. Not a control plane node.
<span class="o">[</span>kubelet-start<span class="o">]</span> Downloading configuration <span class="k">for</span> the kubelet from the <span class="s2">&#34;kubelet-config-1.17&#34;</span> ConfigMap in the kube-system namespace
<span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span class="o">[</span>upgrade<span class="o">]</span> The configuration <span class="k">for</span> this node was successfully updated!
<span class="o">[</span>upgrade<span class="o">]</span> Now you should go ahead and upgrade the kubelet package using your package manager.
</code></pre></td></tr></table>
</div>
</div><h3 id="升级-woker-节点-kubelet-与-kubectl-版本">升级 woker 节点 kubelet 与 kubectl 版本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">yum install -y kubectl-1.17.5-0 kubelet-1.17.5-0 --disableexcludes<span class="o">=</span>kubernetes
</code></pre></td></tr></table>
</div>
</div><h3 id="重启-kubelet-服务">重启 kubelet 服务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ systemctl daemon-reload
$ systemctl restart kubelet
$ systemctl status kubelet
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/kubelet.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: active <span class="o">(</span>running<span class="o">)</span> since Wed 2020-05-20 20:27:07 CST<span class="p">;</span> 21s ago
     Docs: https://kubernetes.io/docs/
 Main PID: <span class="m">4202</span> <span class="o">(</span>kubelet<span class="o">)</span>
    Tasks: <span class="m">18</span>
   Memory: 38.0M
   CGroup: /system.slice/kubelet.service
           └─4202 /usr/bin/kubelet --bootstrap-kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span class="o">=</span>/et...

May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.637150    <span class="m">4202</span> kuberuntime_manager.go:981<span class="o">]</span> updating....0/24
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.637283    <span class="m">4202</span> docker_service.go:355<span class="o">]</span> docker cri re...4,<span class="o">}</span>,<span class="o">}</span>
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.637397    <span class="m">4202</span> kubelet_network.go:77<span class="o">]</span> Setting Pod C....0/24
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.638934    <span class="m">4202</span> kubelet_node_status.go:70<span class="o">]</span> Attemptin...ode01
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.653131    <span class="m">4202</span> kubelet_node_status.go:112<span class="o">]</span> Node k8s...tered
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.653222    <span class="m">4202</span> kubelet_node_status.go:73<span class="o">]</span> Successfu...ode01
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: E0520 20:27:28.657774    <span class="m">4202</span> kubelet.go:1844<span class="o">]</span> skipping pod synchr...d yet
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: I0520 20:27:28.659901    <span class="m">4202</span> setters.go:537<span class="o">]</span> Node became not ready: <span class="o">{</span>T...
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: W0520 20:27:28.842260    <span class="m">4202</span> docker_sandbox.go:394<span class="o">]</span> failed to <span class="nb">read</span> pod...
May <span class="m">20</span> 20:27:28 k8s-node01 kubelet<span class="o">[</span>4202<span class="o">]</span>: E0520 20:27:28.857932    <span class="m">4202</span> kubelet.go:1844<span class="o">]</span> skipping pod synchr...d yet
Hint: Some lines were ellipsized, use -l to show in full.
</code></pre></td></tr></table>
</div>
</div><h3 id="解除-worker-节点污点">解除 worker 节点污点</h3>
<blockquote>
<p>在 Master 节点上操作</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl uncordon k8s-node01
node/k8s-node01 uncordoned
</code></pre></td></tr></table>
</div>
</div><h3 id="验证-worker-节点版本">验证 worker 节点版本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get nodes
NAME         STATUS   ROLES    AGE    VERSION
k8s-master   Ready    master   180d   v1.17.2
k8s-node01   Ready    &lt;none&gt;   180d   v1.17.5
k8s-node02   Ready    &lt;none&gt;   180d   v1.17.5
k8s-node03   Ready    &lt;none&gt;   180d   v1.17.5
k8s-node04   Ready    &lt;none&gt;   180d   v1.17.5
k8s-node05   Ready    &lt;none&gt;   180d   v1.17.5
k8s-node06   Ready    &lt;none&gt;   180d   v1.17.5
</code></pre></td></tr></table>
</div>
</div><p>如上，再以相同的方法更新到 1.18.x 版本即可</p>
<h2 id="验证集群状态">验证集群状态</h2>
<h3 id="检查系统组件">检查系统组件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get pods -n kube-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-7d4d547dd6-59xqn   1/1     Running   <span class="m">0</span>          17m
calico-node-8d8bm                          1/1     Running   <span class="m">0</span>          19h
calico-node-hlv2h                          1/1     Running   <span class="m">0</span>          19h
calico-node-nbt4b                          1/1     Running   <span class="m">0</span>          19h
calico-node-p4s45                          1/1     Running   <span class="m">4</span>          19h
calico-node-srb88                          1/1     Running   <span class="m">0</span>          19h
calico-node-vfpfv                          1/1     Running   <span class="m">0</span>          19h
coredns-546565776c-54gxr                   1/1     Running   <span class="m">0</span>          12m
coredns-546565776c-zqhcb                   1/1     Running   <span class="m">0</span>          20m
etcd-k8s-master                            1/1     Running   <span class="m">0</span>          20m
istio-cni-node-42ngc                       2/2     Running   <span class="m">0</span>          10h
istio-cni-node-6qngn                       2/2     Running   <span class="m">0</span>          10h
istio-cni-node-8pzlj                       2/2     Running   <span class="m">0</span>          10h
istio-cni-node-9p47g                       2/2     Running   <span class="m">0</span>          10h
istio-cni-node-hqp75                       2/2     Running   <span class="m">0</span>          10h
istio-cni-node-vmnbp                       2/2     Running   <span class="m">10</span>         10h
kube-apiserver-k8s-master                  1/1     Running   <span class="m">0</span>          20m
kube-controller-manager-k8s-master         1/1     Running   <span class="m">0</span>          20m
kube-proxy-86845                           1/1     Running   <span class="m">0</span>          19m
kube-proxy-dnccs                           1/1     Running   <span class="m">0</span>          20m
kube-proxy-grn6t                           1/1     Running   <span class="m">0</span>          19m
kube-proxy-ltwdr                           1/1     Running   <span class="m">0</span>          19m
kube-proxy-p5mn8                           1/1     Running   <span class="m">0</span>          19m
kube-proxy-qrnb7                           1/1     Running   <span class="m">0</span>          19m
kube-scheduler-k8s-master                  1/1     Running   <span class="m">0</span>          20m
metrics-server-747dfbd64b-5nnlz            1/1     Running   <span class="m">0</span>          23s
</code></pre></td></tr></table>
</div>
</div><h3 id="测试-dns-功能">测试 DNS 功能</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ dig www.baidu.com @10.96.0.10 +short
www.a.shifen.com.
112.80.248.75
112.80.248.76
$ dig kubernetes.default.svc.cluster.local @10.96.0.10 +short
10.96.0.1
$ kubectl run -n kube-ops -i --rm --restart<span class="o">=</span>Never dummy --image<span class="o">=</span>busybox:1.28 -- nslookup kubernetes.default
Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
Name:      kubernetes.default
Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
pod <span class="s2">&#34;dummy&#34;</span> deleted
</code></pre></td></tr></table>
</div>
</div><h3 id="测试访问集群中的服务">测试访问集群中的服务</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get service -n default
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
whoami       ClusterIP   10.96.179.57   &lt;none&gt;        80/TCP    21d
$ curl http://10.96.179.57
Hostname: whoami-5b4bb9c787-xz87j
IP: 127.0.0.1
IP: 172.16.217.76
RemoteAddr: 127.0.0.1:33338
GET / HTTP/1.1
Host: 10.96.179.57
User-Agent: curl/7.29.0
Accept: */*
$ kubectl run curl -n kube-ops -it --image curlimages/curl --restart Never --rm -- curl whoami.default
Hostname: whoami-5b4bb9c787-xz87j
IP: 127.0.0.1
IP: 172.16.217.76
RemoteAddr: 127.0.0.1:35506
GET / HTTP/1.1
Host: whoami.default
User-Agent: curl/7.70.0-DEV
Accept: */*
pod <span class="s2">&#34;curl&#34;</span> deleted
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-05-20</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/kubernetes/">kubernetes</a>,&nbsp;<a href="/tags/kubeadm/">kubeadm</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/kubeadm-%E5%AE%89%E8%A3%85%E5%8D%95master%E9%9B%86%E7%BE%A4/" class="prev" rel="prev" title="kubeadm 安装单master集群"><i class="fas fa-angle-left fa-fw"></i>kubeadm 安装单master集群</a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011202011734"><img src="//p.ssl.qhmsg.com/t01d8eda6e551cf2615.png"/>沪公网安备 31011202011734号</p></a></div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.9"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">戴先森</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">沪ICP备13017200号</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><style>.lg-toolbar .lg-icon::after { color: #999; }</style><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"gitalk":{"admin":["linuxyunwei"],"clientID":"e0ebb50b7471a999a10f","clientSecret":"1c47fb3b5af8c3f7840e0e8a8cd5b69ee10b682f","id":"2020-05-20T19:17:26+08:00","owner":"linuxyunwei","repo":"linuxyunwei.com","title":"使用Kubeadm更新集群"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"QK0DPR8U9U","algoliaIndex":"linuxyunwei.com","algoliaSearchKey":"ed629decd2fd8c246289576b705eb412","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
