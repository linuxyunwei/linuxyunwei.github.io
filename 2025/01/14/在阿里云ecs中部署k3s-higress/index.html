<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>在阿里云ECS中部署k3s+Higress | 戴先森的学习笔记</title>
<meta name=keywords content><meta name=description content="去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\"><meta name=author content="Xijun Dai"><link rel=canonical href=https://linuxyunwei.com/2025/01/14/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91ecs%E4%B8%AD%E9%83%A8%E7%BD%B2k3s-higress/><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxyunwei.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxyunwei.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxyunwei.com/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxyunwei.com/apple-touch-icon.png><link rel=mask-icon href=https://linuxyunwei.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://linuxyunwei.com/2025/01/14/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91ecs%E4%B8%AD%E9%83%A8%E7%BD%B2k3s-higress/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://linuxyunwei.com/2025/01/14/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91ecs%E4%B8%AD%E9%83%A8%E7%BD%B2k3s-higress/"><meta property="og:site_name" content="戴先森的学习笔记"><meta property="og:title" content="在阿里云ECS中部署k3s+Higress"><meta property="og:description" content="去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-14T00:47:00+08:00"><meta property="article:modified_time" content="2025-01-14T10:31:22+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="在阿里云ECS中部署k3s+Higress"><meta name=twitter:description content="去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"在阿里云ECS中部署k3s+Higress","item":"https://linuxyunwei.com/2025/01/14/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91ecs%E4%B8%AD%E9%83%A8%E7%BD%B2k3s-higress/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"在阿里云ECS中部署k3s+Higress","name":"在阿里云ECS中部署k3s\u002bHigress","description":"去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\\\n","keywords":[],"articleBody":"去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\\\n初始化操作系统 登录到阿里云 ECS 控制台，找到需要配置的 ECS， 选择 全部操作 -\u003e 云盘与镜像 -\u003e 更换操作系统进行更换操作系统\n由于我的 ECS 还处于运行中的状态， 这里需要先关机\n停止方式默认选 停止就行了。\n待 ECS 关机之后 ， 选择继续更换操作 选好发行版之后点击下方的 确认订单, 这里我选择了 Ubuntu 24.04 部署 k3s 官网安装脚本地址是 https://get.k3s.io , 在大陆地区可以使用 https://rancher-mirror.rancher.cn/k3s/k3s-install.sh 代替\n找到 ECS 的公网及私网 IP，后面会用到 通过终端工具 SSH 登录到服务器上安装 k3s\n这里所有的操作均基于 root 用户身份执行，如果更换操作系统时 安全设置里的登录名选择的是 ecs-user, 这里可以先使用 sudo -i 命令切换到 root\n$ sudo -i ## 切换到 root 用户环境 $ export PUBLIC_IP= ## 公网IP $ export PRIVATE_IP= ## 私网IP $ export REGISTRY_MIRROR=dockerproxy.net $ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - \\ --disable-network-policy \\ --disable-helm-controller \\ --disable=traefik \\ --node-external-ip=${PUBLIC_IP} \\ --node-ip=${PRIVATE_IP} \\ --system-default-registry=${REGISTRY_MIRROR} [INFO] Finding release for channel stable [INFO] Using v1.31.4+k3s1 as release [INFO] Downloading hash rancher-mirror.rancher.cn/k3s/v1.31.4-k3s1/sha256sum-amd64.txt [INFO] Downloading binary rancher-mirror.rancher.cn/k3s/v1.31.4-k3s1/k3s [INFO] Verifying binary download [INFO] Installing k3s to /usr/local/bin/k3s [INFO] Skipping installation of SELinux RPM [INFO] Creating /usr/local/bin/kubectl symlink to k3s [INFO] Creating /usr/local/bin/crictl symlink to k3s [INFO] Creating /usr/local/bin/ctr symlink to k3s [INFO] Creating killall script /usr/local/bin/k3s-killall.sh [INFO] Creating uninstall script /usr/local/bin/k3s-uninstall.sh [INFO] env: Creating environment file /etc/systemd/system/k3s.service.env [INFO] systemd: Creating service file /etc/systemd/system/k3s.service [INFO] systemd: Enabling k3s unit Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service. [INFO] systemd: Starting k3s 参数说明:\n–disable-network-policy: 禁用网络策略，单机环境不需要开启 –disable-helm-controller: 禁用自带的 helm 控制器， 服务都是需要外部工具部署的，暂时用不上 –disable=traefik: 禁用默认的 traefik 网关，可以多次指定需要禁用的组件，如 coredns, metrics-server,local-storage,servicelb。个人不习惯使用 traefik 所以先禁用，后面使用 higress来代替 –node-external-ip: 指定 ECS 的公网 IP –node-ip: 指定 ECS 的内网(VPC)IP –system-default-registry: 默认情况下所有未指定仓库地址的镜像都是从 dockerhub 官方仓库拉取的，在国内环境或部分企业内网可能会无法正常访问到，可以通过这个参数指定代理仓库地址 查看集群运行状态\n$ kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-6d4d797fc6-r2wcz 1/1 Running 0 3m33s kube-system local-path-provisioner-749cdf74fc-vj9z5 1/1 Running 0 3m33s kube-system metrics-server-568d68f85d-s5q4k 1/1 Running 0 3m33s 部署 Higress 网关 Higress 的部署方式可以参考官网的 hgctl 工具使用说明 和 使用 Helm 进行云原生部署\n我这里使用 kustomize + helm 结合的方式来管理部署\n## 创建目录用于存储配置文件 $ mkdir higress \u0026\u0026 cd higress ## 安装helm $ snap install helm --classic 2025-01-18T19:01:04+08:00 INFO Waiting for automatic snapd restart... helm 3.16.4 from Snapcrafters✪ installed $ helm version version.BuildInfo{Version:\"v3.16.4\", GitCommit:\"7877b45b63f95635153b29a42c0c2f4273ec45ca\", GitTreeState:\"clean\", GoVersion:\"go1.22.7\"} ## 添加 higress chart 仓库 $ helm repo add higress.io https://higress.io/helm-charts \"higress.io\" has been added to your repositories $ helm search repo higress.io/ NAME CHART VERSION APP VERSION DESCRIPTION higress.io/higress 2.0.6 2.0.6 Helm chart for deploying Higress gateways higress.io/higress-console 2.0.2 2.0.2 Management console for Higress higress.io/higress-core 2.0.6 2.0.6 Helm chart for deploying higress gateways ... ## 生成默认 values.yaml 文件 $ helm show values higress.io/higress-core | tee values.yaml 注意，我这里使用的是 higress.io/higress-core, 是因为 higress.io/higress 包含了 core 和 console(UI) 这两部分，我这里暂时用不着 console\n修改完成后的 values.yaml 文件内容如下:\nglobal: ingressClass: higress watchNamespace: '' disableAlpnH2: true enableStatus: true # whether to use autoscaling/v2 template for HPA settings # for internal usage only, not to be configured by users. autoscalingv2API: true enableIstioAPI: true enableGatewayAPI: false namespace: higress-system meshConfig: enablePrometheusMerge: true rootNamespace: '' trustDomain: cluster.local gateway: replicas: 1 ## ECS配置较低，我这里改成了1个pod，建议最少保持2个 metrics: enabled: false service: externalTrafficPolicy: Local resources: requests: cpu: 10m memory: 64Mi controller: replicas: 1 ## 以下为开启 let's encrypt 自动签发域名SSL证书功能 automaticHttps: enabled: true email: ## 这里填自己的邮箱 resources: requests: cpu: 10m memory: 64Mi pilot: replicaCount: 1 resources: requests: cpu: 10m memory: 64Mi 定义创建名为 higress-system 的命名空间， 文件名 namespace.yaml\n## file: namespace.yaml apiVersion: v1 kind: Namespace metadata: name: higress-system 创建 kustomize 的配置文件 kustomization.yaml, 内容如下:\n# file: kustomization.yaml apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization resources: - https://github.com/alibaba/higress/releases/download/v2.0.6/crd.yaml - namespace.yaml ## 参考: https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#_helmchartinflationgenerator_ helmCharts: - name: higress-core repo: https://higress.io/helm-charts releaseName: higress namespace: higress-system version: 2.0.6 ## \u003c\u003c- helm chart version valuesFile: values.yaml 最终的目录结构如下:\n$ tree -l . ├── kustomization.yaml ├── namespace.yaml └── values.yaml 查看渲染后的内容是否符合预期\nkubectl kustomize --enable-helm . 确认无误后部署到 k3s 集群\n## 注意: 这里因为使用 kustomize 管理了 helmChart, 所以不能直接使用 kubectl apply -k 来部署 $ kubectl kustomize --enable-helm . | kubectl apply -f - namespace/higress-system created customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io created customresourcedefinition.apiextensions.k8s.io/http2rpcs.networking.higress.io created customresourcedefinition.apiextensions.k8s.io/mcpbridges.networking.higress.io created customresourcedefinition.apiextensions.k8s.io/wasmplugins.extensions.higress.io created serviceaccount/higress-controller created serviceaccount/higress-gateway created role.rbac.authorization.k8s.io/higress-controller created role.rbac.authorization.k8s.io/higress-gateway created clusterrole.rbac.authorization.k8s.io/higress-controller-higress-system created clusterrole.rbac.authorization.k8s.io/higress-gateway-higress-system created rolebinding.rbac.authorization.k8s.io/higress-controller created rolebinding.rbac.authorization.k8s.io/higress-gateway created clusterrolebinding.rbac.authorization.k8s.io/higress-controller-higress-system created clusterrolebinding.rbac.authorization.k8s.io/higress-gateway-higress-system created configmap/higress-config created service/higress-controller created service/higress-gateway created deployment.apps/higress-controller created deployment.apps/higress-gateway created ingressclass.networking.k8s.io/higress created envoyfilter.networking.istio.io/higress-gateway-global-custom-response created 这里可能会遇到创建 higress-gateway-global-custom-response 资源报错，错误信息如下，这里因为 CRD 资源还没有部署好，上面的部署命令重新执行一次就好了\nerror: resource mapping not found for name: \"higress-gateway-global-custom-response\" namespace: \"higress-system\" from \"STDIN\": no matches for kind \"EnvoyFilter\" in version \"networking.istio.io/v1alpha3\" ensure CRDs are installed first 查看部署状态\n$ kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE higress-system higress-controller-59c96d96c9-chkhz 2/2 Running 0 3m44s higress-system higress-gateway-55777cf55d-m9vj2 1/1 Running 0 3m44s .... kube-system svclb-higress-gateway-878678d4-r4n6z 2/2 Running 0 3m44s $ kubectl get -n higress-system svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE higress-controller ClusterIP 10.43.239.208 8888/TCP,8889/TCP,15051/TCP,15010/TCP,15012/TCP,443/TCP,15014/TCP 4m45s higress-gateway LoadBalancer 10.43.18.51 101.37.18.109 80:31368/TCP,443:31372/TCP 4m44s 验证网关 这里部署个 httpbin 验证下网关， 以 istio 中提供的配置为例，因国内环境无法直接拉取到 docker.io 的镜像，所以我们先把 yaml 文件 copy 下来修改下镜像仓库地址，这里替换为阿里云的专属镜像加速器地址，修改后的文件内容如下:\n# Copyright Istio Authors # # Licensed under the Apache License, Version 2.0 (the \"License\"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \"AS IS\" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. ################################################################################################## # httpbin service ################################################################################################## apiVersion: v1 kind: ServiceAccount metadata: name: httpbin --- apiVersion: v1 kind: Service metadata: name: httpbin labels: app: httpbin service: httpbin spec: ports: - name: http port: 8000 targetPort: 8080 selector: app: httpbin --- apiVersion: apps/v1 kind: Deployment metadata: name: httpbin spec: replicas: 1 selector: matchLabels: app: httpbin version: v1 template: metadata: labels: app: httpbin version: v1 spec: serviceAccountName: httpbin containers: ## 这里将 docker.io 替换为 dockerproxy.net - image: dockerproxy.net/mccutchen/go-httpbin:v2.15.0 imagePullPolicy: IfNotPresent name: httpbin ports: - containerPort: 8080 部署 httpbin 到集群\n$ kubectl apply -f httpbin.yaml serviceaccount/httpbin created service/httpbin created deployment.apps/httpbin created $ kubectl get pods NAME READY STATUS RESTARTS AGE httpbin-5f4ffff868-9m5hn 1/1 Running 0 5s 生成 Ingress 路由配置， 内容如下:\n# file: ingress.yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: httpbin spec: ingressClassName: higress ## 这里指定使用 higress rules: - host: httpbin.linuxyunwei.com ## 访问域名 http: paths: - backend: service: name: httpbin port: number: 8000 path: / pathType: Prefix tls: - hosts: - httpbin.linuxyunwei.com 注意看上面的 Ingress 中，我们并没有指定 tls 的 secretName ， 后面我会通过 higress 的 automaticHttps 功能对接 let’s encrypt 自动签发证书\n部署 Ingress 路由到集群\n$ kubectl apply -f ingress.yaml ingress.networking.k8s.io/httpbin created $ kubectl get ingress NAME CLASS HOSTS ADDRESS PORTS AGE httpbin higress httpbin.linuxyunwei.com 101.37.18.109 80, 443 4s 添加 DNS 解析记录，这里以阿里云为例 待 DNS 生效后可以尝试使用 curl 访问\n$ nslookup httpbin.linuxyunwei.com Server: 127.0.0.53 Address: 127.0.0.53#53 Non-authoritative answer: Name: httpbin.linuxyunwei.com Address: 101.37.18.109 ## 正常情况会看到如下内容 $ curl http://httpbin.linuxyunwei.com/headers { \"headers\": { \"Accept\": [ \"*/*\" ], \"Host\": [ \"httpbin.linuxyunwei.com\" ], \"Req-Start-Time\": [ \"1737260136218\" ], \"User-Agent\": [ \"curl/8.5.0\" ], \"X-Envoy-Attempt-Count\": [ \"1\" ], \"X-Envoy-Decorator-Operation\": [ \"httpbin.default.svc.cluster.local:8000/*\" ], \"X-Envoy-Internal\": [ \"true\" ], \"X-Envoy-Original-Host\": [ \"httpbin.linuxyunwei.com\" ], \"X-Envoy-Route-Identifier\": [ \"true\" ], \"X-Forwarded-For\": [ \"10.42.0.1\" ], \"X-Forwarded-Proto\": [ \"http\" ], \"X-Request-Id\": [ \"bf98143d-cd47-449b-9e5a-267a91478a5f\" ] } } Higress 中开启 TLS 证书自动托管 上一步中创建了 httpbin 服务，并通过 http 协议访问正常，但我们还没有配置 tls 证书，所以如果使用 https 访问会出现问题，如果你已经有了证书， 可以通过配置 Ingress 中 spec.tls.secretName 字段选择已有证书的 Secret。 我这里并没有事先申请证书，就需要由 higress 代劳了。\n$ kubectl edit configmap higress-https -n higress-system apiVersion: v1 data: cert: | acmeIssuer: - ak: \"\" email: daixijun1990@gmail.com name: letsencrypt sk: \"\" automaticHttps: true credentialConfig: - domains: - httpbin.linuxyunwei.com ## 添加自己的域名,可以有多个 tlsSecret: httpbin-linuxyunwei-com-tls ## 用来存储证书的 secret 名称 tlsIssuer: letsencrypt ## 指定使用 let's encrypt fallbackForInvalidSecret: true renewBeforeDays: 30 version: \"20250118113351\" ## 稍等一会之后就可以看到证书已经创建好了 $ kubectl get secret -n higress-system NAME TYPE DATA AGE httpbin-linuxyunwei-com-tls kubernetes.io/tls 2 6m36s ## 我们现在使用 https 访问下试试 $ curl -v https://httpbin.linuxyunwei.com/status/200 * Host httpbin.linuxyunwei.com:443 was resolved. * IPv6: (none) * IPv4: 101.37.18.109 * Trying 101.37.18.109:443... * Connected to httpbin.linuxyunwei.com (101.37.18.109) port 443 * ALPN: curl offers h2,http/1.1 * TLSv1.3 (OUT), TLS handshake, Client hello (1): * CAfile: /etc/ssl/certs/ca-certificates.crt * CApath: /etc/ssl/certs * TLSv1.3 (IN), TLS handshake, Server hello (2): * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8): * TLSv1.3 (IN), TLS handshake, Certificate (11): * TLSv1.3 (IN), TLS handshake, CERT verify (15): * TLSv1.3 (IN), TLS handshake, Finished (20): * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1): * TLSv1.3 (OUT), TLS handshake, Finished (20): * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / X25519 / id-ecPublicKey * ALPN: server accepted http/1.1 * Server certificate: * subject: CN=httpbin.linuxyunwei.com * start date: Jan 19 03:30:15 2025 GMT * expire date: Apr 19 03:30:14 2025 GMT * subjectAltName: host \"httpbin.linuxyunwei.com\" matched cert's \"httpbin.linuxyunwei.com\" * issuer: C=US; O=Let's Encrypt; CN=E6 * SSL certificate verify ok. * Certificate level 0: Public key type EC/prime256v1 (256/128 Bits/secBits), signed using ecdsa-with-SHA384 * Certificate level 1: Public key type EC/secp384r1 (384/192 Bits/secBits), signed using sha256WithRSAEncryption * Certificate level 2: Public key type RSA (4096/152 Bits/secBits), signed using sha256WithRSAEncryption * using HTTP/1.x \u003e GET /status/200 HTTP/1.1 \u003e Host: httpbin.linuxyunwei.com \u003e User-Agent: curl/8.5.0 \u003e Accept: */* \u003e * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): * old SSL session ID is stale, removing \u003c HTTP/1.1 200 OK \u003c access-control-allow-credentials: true \u003c access-control-allow-origin: * \u003c content-type: text/plain; charset=utf-8 \u003c date: Sun, 19 Jan 2025 04:37:32 GMT \u003c content-length: 0 \u003c req-cost-time: 1 \u003c req-arrive-time: 1737261452765 \u003c resp-start-time: 1737261452767 \u003c x-envoy-upstream-service-time: 1 \u003c server: istio-envoy \u003c * Connection #0 to host httpbin.linuxyunwei.com left intact 如果证书未能正常申请， 可以通过如下命令查看控制端的日志进行排查\nkubectl logs --tail 200 -f -n higress-system -l higress=higress-controller -c discovery 参考 Installation Configuration Options Kustomize Built-Ins | helmCharts feat:add higress automatic https by 2456868764 · Pull Request #854 · alibaba/higress · GitHub ","wordCount":"2636","inLanguage":"zh-cn","datePublished":"2025-01-14T00:47:00+08:00","dateModified":"2025-01-14T10:31:22+08:00","author":{"@type":"Person","name":"Xijun Dai"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxyunwei.com/2025/01/14/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91ecs%E4%B8%AD%E9%83%A8%E7%BD%B2k3s-higress/"},"publisher":{"@type":"Organization","name":"戴先森的学习笔记","logo":{"@type":"ImageObject","url":"https://linuxyunwei.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxyunwei.com/ accesskey=h title="戴先森的学习笔记 (Alt + H)">戴先森的学习笔记</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxyunwei.com/ title=Home><span>Home</span></a></li><li><a href=https://linuxyunwei.com/articles/ title=Articles><span>Articles</span></a></li><li><a href=https://linuxyunwei.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://linuxyunwei.com/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxyunwei.com/>Home</a></div><h1 class="post-title entry-hint-parent">在阿里云ECS中部署k3s+Higress</h1><div class=post-meta><span title='2025-01-14 00:47:00 +0800 +0800'>January 14, 2025</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;2636 words&nbsp;·&nbsp;Xijun Dai&nbsp;|&nbsp;<a href=https://github.com/linuxyunwei/linuxyunwei.com/tree/master/content/posts/%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s+Higress.md rel="noopener noreferrer" target=_blank>修正错误</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#初始化操作系统>初始化操作系统</a></li><li><a href=#部署-k3s>部署 k3s</a></li><li><a href=#部署-higress-网关>部署 Higress 网关</a></li><li><a href=#验证网关>验证网关</a></li><li><a href=#higress-中开启-tls-证书自动托管>Higress 中开启 TLS 证书自动托管</a></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div><div class=post-content><p>去年阿里云搞活动的时候 99/年(续费不涨价)购买了一台 2 核 2G 的 ECS 一直空放着没有使用， 最近收到短信提示要到期了。就想着用来干点啥，工作中习惯了使用 K8s 管理业务，就先考虑部署一套 k3s 环境，具体用来做什么后面再说 -_-\</p><h2 id=初始化操作系统>初始化操作系统<a hidden class=anchor aria-hidden=true href=#初始化操作系统>#</a></h2><p>登录到阿里云 ECS 控制台，找到需要配置的 ECS， 选择 <code>全部操作</code> -> <code>云盘与镜像</code> -> <code>更换操作系统</code>进行更换操作系统</p><p><img loading=lazy src=https://static.linuxyunwei.com/images/20250118175050203.png></p><p>由于我的 ECS 还处于运行中的状态， 这里需要先关机</p><p><img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250118175847780.png></p><p>停止方式默认选 <code>停止</code>就行了。</p><p><img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250118180025137.png></p><p>待 ECS 关机之后 ， 选择<code>继续更换操作</code>
<img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250118180103413.png></p><p>选好发行版之后点击下方的 <code>确认订单</code>, 这里我选择了 Ubuntu 24.04
<img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250118180259473.png></p><h2 id=部署-k3s>部署 k3s<a hidden class=anchor aria-hidden=true href=#部署-k3s>#</a></h2><blockquote><p>官网安装脚本地址是 <a href=https://get.k3s.io/>https://get.k3s.io</a> , 在大陆地区可以使用 <a href=https://rancher-mirror.rancher.cn/k3s/k3s-install.sh>https://rancher-mirror.rancher.cn/k3s/k3s-install.sh</a> 代替</p></blockquote><p>找到 ECS 的公网及私网 IP，后面会用到
<img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250118181038018.png></p><p>通过终端工具 SSH 登录到服务器上安装 k3s</p><blockquote><p>这里所有的操作均基于 <code>root</code> 用户身份执行，如果更换操作系统时 <code>安全设置</code>里的<code>登录名</code>选择的是 <code>ecs-user</code>, 这里可以先使用 <code>sudo -i</code> 命令切换到 <code>root</code></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo -i <span class=c1>## 切换到 root 用户环境</span>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>PUBLIC_IP</span><span class=o>=</span>&lt;Your ECS Public IP&gt;  <span class=c1>## 公网IP</span>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>PRIVATE_IP</span><span class=o>=</span>&lt;Your ECS Private IP&gt;   <span class=c1>## 私网IP</span>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>REGISTRY_MIRROR</span><span class=o>=</span>dockerproxy.net
</span></span><span class=line><span class=cl>$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh <span class=p>|</span> <span class=nv>INSTALL_K3S_MIRROR</span><span class=o>=</span>cn sh -s - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disable-network-policy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disable-helm-controller <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disable<span class=o>=</span>traefik <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --node-external-ip<span class=o>=</span><span class=si>${</span><span class=nv>PUBLIC_IP</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --node-ip<span class=o>=</span><span class=si>${</span><span class=nv>PRIVATE_IP</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --system-default-registry<span class=o>=</span><span class=si>${</span><span class=nv>REGISTRY_MIRROR</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Finding release <span class=k>for</span> channel stable
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Using v1.31.4+k3s1 as release
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Downloading <span class=nb>hash</span> rancher-mirror.rancher.cn/k3s/v1.31.4-k3s1/sha256sum-amd64.txt
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Downloading binary rancher-mirror.rancher.cn/k3s/v1.31.4-k3s1/k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Verifying binary download
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Installing k3s to /usr/local/bin/k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Skipping installation of SELinux RPM
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/kubectl symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/crictl symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/ctr symlink to k3s
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating killall script /usr/local/bin/k3s-killall.sh
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  env: Creating environment file /etc/systemd/system/k3s.service.env
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Creating service file /etc/systemd/system/k3s.service
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Enabling k3s unit
</span></span><span class=line><span class=cl>Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span>  systemd: Starting k3s
</span></span></code></pre></div><p>参数说明:</p><ul><li><strong>&ndash;disable-network-policy</strong>: 禁用网络策略，单机环境不需要开启</li><li><strong>&ndash;disable-helm-controller</strong>: 禁用自带的 helm 控制器， 服务都是需要外部工具部署的，暂时用不上</li><li><strong>&ndash;disable=traefik</strong>: 禁用默认的 traefik 网关，可以多次指定需要禁用的组件，如 <code>coredns</code>, <code>metrics-server</code>,<code>local-storage</code>,<code>servicelb</code>。个人不习惯使用 <code>traefik</code> 所以先禁用，后面使用 <a href=https://higress.cn>higress</a>来代替</li><li><strong>&ndash;node-external-ip</strong>: 指定 ECS 的公网 IP</li><li><strong>&ndash;node-ip</strong>: 指定 ECS 的内网(VPC)IP</li><li><strong>&ndash;system-default-registry</strong>: 默认情况下所有未指定仓库地址的镜像都是从 dockerhub 官方仓库拉取的，在国内环境或部分企业内网可能会无法正常访问到，可以通过这个参数指定代理仓库地址</li></ul><p>查看集群运行状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -A
</span></span><span class=line><span class=cl>NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>kube-system   coredns-6d4d797fc6-r2wcz                  1/1     Running   <span class=m>0</span>          3m33s
</span></span><span class=line><span class=cl>kube-system   local-path-provisioner-749cdf74fc-vj9z5   1/1     Running   <span class=m>0</span>          3m33s
</span></span><span class=line><span class=cl>kube-system   metrics-server-568d68f85d-s5q4k           1/1     Running   <span class=m>0</span>          3m33s
</span></span></code></pre></div><h2 id=部署-higress-网关>部署 Higress 网关<a hidden class=anchor aria-hidden=true href=#部署-higress-网关>#</a></h2><p>Higress 的部署方式可以参考官网的 <a href=https://higress.cn/docs/latest/ops/hgctl/>hgctl 工具使用说明</a> 和 <a href=https://higress.cn/docs/latest/ops/deploy-by-helm/>使用 Helm 进行云原生部署</a></p><p>我这里使用 kustomize + helm 结合的方式来管理部署</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 创建目录用于存储配置文件</span>
</span></span><span class=line><span class=cl>$ mkdir higress <span class=o>&amp;&amp;</span> <span class=nb>cd</span> higress
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 安装helm</span>
</span></span><span class=line><span class=cl>$ snap install helm --classic
</span></span><span class=line><span class=cl>2025-01-18T19:01:04+08:00 INFO Waiting <span class=k>for</span> automatic snapd restart...
</span></span><span class=line><span class=cl>helm 3.16.4 from Snapcrafters✪ installed
</span></span><span class=line><span class=cl>$ helm version
</span></span><span class=line><span class=cl>version.BuildInfo<span class=o>{</span>Version:<span class=s2>&#34;v3.16.4&#34;</span>, GitCommit:<span class=s2>&#34;7877b45b63f95635153b29a42c0c2f4273ec45ca&#34;</span>, GitTreeState:<span class=s2>&#34;clean&#34;</span>, GoVersion:<span class=s2>&#34;go1.22.7&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 添加 higress chart 仓库</span>
</span></span><span class=line><span class=cl>$ helm repo add higress.io https://higress.io/helm-charts
</span></span><span class=line><span class=cl><span class=s2>&#34;higress.io&#34;</span> has been added to your repositories
</span></span><span class=line><span class=cl>$ helm search repo higress.io/
</span></span><span class=line><span class=cl>NAME                            CHART VERSION   APP VERSION     DESCRIPTION
</span></span><span class=line><span class=cl>higress.io/higress              2.0.6           2.0.6           Helm chart <span class=k>for</span> deploying Higress gateways
</span></span><span class=line><span class=cl>higress.io/higress-console      2.0.2           2.0.2           Management console <span class=k>for</span> Higress
</span></span><span class=line><span class=cl>higress.io/higress-core         2.0.6           2.0.6           Helm chart <span class=k>for</span> deploying higress gateways
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 生成默认 values.yaml 文件</span>
</span></span><span class=line><span class=cl>$ helm show values higress.io/higress-core <span class=p>|</span> tee values.yaml
</span></span></code></pre></div><blockquote><p>注意，我这里使用的是 higress.io/higress-core, 是因为 higress.io/higress 包含了 core 和 console(UI) 这两部分，我这里暂时用不着 console</p></blockquote><p>修改完成后的 values.yaml 文件内容如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClass</span><span class=p>:</span><span class=w> </span><span class=l>higress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>watchNamespace</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>disableAlpnH2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableStatus</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># whether to use autoscaling/v2 template for HPA settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># for internal usage only, not to be configured by users.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>autoscalingv2API</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableIstioAPI</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableGatewayAPI</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>higress-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>meshConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enablePrometheusMerge</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rootNamespace</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trustDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>gateway</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=c>## ECS配置较低，我这里改成了1个pod，建议最少保持2个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>64Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controller</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 以下为开启 let&#39;s encrypt 自动签发域名SSL证书功能</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>automaticHttps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Your Email&gt;</span><span class=w> </span><span class=c>## 这里填自己的邮箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>64Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>pilot</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>64Mi</span><span class=w>
</span></span></span></code></pre></div><p>定义创建名为 <code>higress-system</code> 的命名空间， 文件名 <code>namespace.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## file: namespace.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>higress-system</span><span class=w>
</span></span></span></code></pre></div><p>创建 kustomize 的配置文件 <code>kustomization.yaml</code>, 内容如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># file: kustomization.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://github.com/alibaba/higress/releases/download/v2.0.6/crd.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>namespace.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## 参考: https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#_helmchartinflationgenerator_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>helmCharts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>higress-core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>https://higress.io/helm-charts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class=l>higress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>higress-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2.0.6</span><span class=w> </span><span class=c>## &lt;&lt;- helm chart version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valuesFile</span><span class=p>:</span><span class=w> </span><span class=l>values.yaml</span><span class=w>
</span></span></span></code></pre></div><p>最终的目录结构如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tree -l
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── kustomization.yaml
</span></span><span class=line><span class=cl>├── namespace.yaml
</span></span><span class=line><span class=cl>└── values.yaml
</span></span></code></pre></div><p>查看渲染后的内容是否符合预期</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize --enable-helm .
</span></span></code></pre></div><p>确认无误后部署到 k3s 集群</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 注意: 这里因为使用 kustomize 管理了 helmChart, 所以不能直接使用 kubectl apply -k 来部署</span>
</span></span><span class=line><span class=cl>$ kubectl kustomize --enable-helm . <span class=p>|</span> kubectl apply -f -
</span></span><span class=line><span class=cl>namespace/higress-system created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/http2rpcs.networking.higress.io created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/mcpbridges.networking.higress.io created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/wasmplugins.extensions.higress.io created
</span></span><span class=line><span class=cl>serviceaccount/higress-controller created
</span></span><span class=line><span class=cl>serviceaccount/higress-gateway created
</span></span><span class=line><span class=cl>role.rbac.authorization.k8s.io/higress-controller created
</span></span><span class=line><span class=cl>role.rbac.authorization.k8s.io/higress-gateway created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/higress-controller-higress-system created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/higress-gateway-higress-system created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/higress-controller created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/higress-gateway created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/higress-controller-higress-system created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/higress-gateway-higress-system created
</span></span><span class=line><span class=cl>configmap/higress-config created
</span></span><span class=line><span class=cl>service/higress-controller created
</span></span><span class=line><span class=cl>service/higress-gateway created
</span></span><span class=line><span class=cl>deployment.apps/higress-controller created
</span></span><span class=line><span class=cl>deployment.apps/higress-gateway created
</span></span><span class=line><span class=cl>ingressclass.networking.k8s.io/higress created
</span></span><span class=line><span class=cl>envoyfilter.networking.istio.io/higress-gateway-global-custom-response created
</span></span></code></pre></div><p>这里可能会遇到创建 <code>higress-gateway-global-custom-response</code> 资源报错，错误信息如下，这里因为 CRD 资源还没有部署好，上面的部署命令重新执行一次就好了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>error: resource mapping not found for name: &#34;higress-gateway-global-custom-response&#34; namespace: &#34;higress-system&#34; from &#34;STDIN&#34;: no matches for kind &#34;EnvoyFilter&#34; in version &#34;networking.istio.io/v1alpha3&#34;
</span></span><span class=line><span class=cl>ensure CRDs are installed first
</span></span></code></pre></div><p>查看部署状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -A
</span></span><span class=line><span class=cl>NAMESPACE        NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>higress-system   higress-controller-59c96d96c9-chkhz       2/2     Running   <span class=m>0</span>          3m44s
</span></span><span class=line><span class=cl>higress-system   higress-gateway-55777cf55d-m9vj2          1/1     Running   <span class=m>0</span>          3m44s
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl>kube-system      svclb-higress-gateway-878678d4-r4n6z      2/2     Running   <span class=m>0</span>          3m44s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl get -n higress-system svc
</span></span><span class=line><span class=cl>NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class=o>(</span>S<span class=o>)</span>                                                             AGE
</span></span><span class=line><span class=cl>higress-controller   ClusterIP      10.43.239.208   &lt;none&gt;          8888/TCP,8889/TCP,15051/TCP,15010/TCP,15012/TCP,443/TCP,15014/TCP   4m45s
</span></span><span class=line><span class=cl>higress-gateway      LoadBalancer   10.43.18.51     101.37.18.109   80:31368/TCP,443:31372/TCP                                          4m44s
</span></span></code></pre></div><h2 id=验证网关>验证网关<a hidden class=anchor aria-hidden=true href=#验证网关>#</a></h2><p>这里部署个 httpbin 验证下网关， 以 istio 中提供的配置为例，因国内环境无法直接拉取到 docker.io 的镜像，所以我们先把 yaml 文件 copy 下来修改下镜像仓库地址，这里替换为阿里云的专属镜像加速器地址，修改后的文件内容如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Copyright Istio Authors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   you may not use this file except in compliance with the License.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   You may obtain a copy of the License at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       http://www.apache.org/licenses/LICENSE-2.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   Unless required by applicable law or agreed to in writing, software</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   See the License for the specific language governing permissions and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   limitations under the License.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##################################################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># httpbin service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##################################################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>## 这里将 docker.io 替换为 dockerproxy.net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>dockerproxy.net/mccutchen/go-httpbin:v2.15.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>部署 httpbin 到集群</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f httpbin.yaml
</span></span><span class=line><span class=cl>serviceaccount/httpbin created
</span></span><span class=line><span class=cl>service/httpbin created
</span></span><span class=line><span class=cl>deployment.apps/httpbin created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>httpbin-5f4ffff868-9m5hn   1/1     Running   <span class=m>0</span>          5s
</span></span></code></pre></div><p>生成 Ingress 路由配置， 内容如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># file: ingress.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>higress</span><span class=w> </span><span class=c>## 这里指定使用 higress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>httpbin.linuxyunwei.com</span><span class=w> </span><span class=c>## 访问域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>httpbin.linuxyunwei.com</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>注意看上面的 Ingress 中，我们并没有指定 tls 的 secretName ， 后面我会通过 higress 的 automaticHttps 功能对接 let&rsquo;s encrypt 自动签发证书</p></blockquote><p>部署 Ingress 路由到集群</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f ingress.yaml
</span></span><span class=line><span class=cl>ingress.networking.k8s.io/httpbin created
</span></span><span class=line><span class=cl>$ kubectl get ingress
</span></span><span class=line><span class=cl>NAME      CLASS    HOSTS                     ADDRESS          PORTS     AGE
</span></span><span class=line><span class=cl>httpbin   higress  httpbin.linuxyunwei.com   101.37.18.109    80, <span class=m>443</span>   4s
</span></span></code></pre></div><p>添加 DNS 解析记录，这里以阿里云为例
<img alt=image.png loading=lazy src=https://static.linuxyunwei.com/images/20250119121102792.png></p><p>待 DNS 生效后可以尝试使用 curl 访问</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ nslookup httpbin.linuxyunwei.com
</span></span><span class=line><span class=cl>Server:         127.0.0.53
</span></span><span class=line><span class=cl>Address:        127.0.0.53#53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Non-authoritative answer:
</span></span><span class=line><span class=cl>Name:   httpbin.linuxyunwei.com
</span></span><span class=line><span class=cl>Address: 101.37.18.109
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 正常情况会看到如下内容</span>
</span></span><span class=line><span class=cl>$ curl http://httpbin.linuxyunwei.com/headers
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;headers&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Accept&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;*/*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Host&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;httpbin.linuxyunwei.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Req-Start-Time&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;1737260136218&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;User-Agent&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;curl/8.5.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Envoy-Attempt-Count&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Envoy-Decorator-Operation&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;httpbin.default.svc.cluster.local:8000/*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Envoy-Internal&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Envoy-Original-Host&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;httpbin.linuxyunwei.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Envoy-Route-Identifier&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Forwarded-For&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;10.42.0.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Forwarded-Proto&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;X-Request-Id&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;bf98143d-cd47-449b-9e5a-267a91478a5f&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=higress-中开启-tls-证书自动托管>Higress 中开启 TLS 证书自动托管<a hidden class=anchor aria-hidden=true href=#higress-中开启-tls-证书自动托管>#</a></h2><p>上一步中创建了 httpbin 服务，并通过 http 协议访问正常，但我们还没有配置 tls 证书，所以如果使用 https 访问会出现问题，如果你已经有了证书， 可以通过配置 Ingress 中 spec.tls.secretName 字段选择已有证书的 Secret。 我这里并没有事先申请证书，就需要由 higress 代劳了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl edit configmap higress-https -n higress-system
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  cert: <span class=p>|</span>
</span></span><span class=line><span class=cl>    acmeIssuer:
</span></span><span class=line><span class=cl>    - ak: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>      email: daixijun1990@gmail.com
</span></span><span class=line><span class=cl>      name: letsencrypt
</span></span><span class=line><span class=cl>      sk: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    automaticHttps: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    credentialConfig:
</span></span><span class=line><span class=cl>    - domains:
</span></span><span class=line><span class=cl>      - httpbin.linuxyunwei.com  <span class=c1>## 添加自己的域名,可以有多个</span>
</span></span><span class=line><span class=cl>      tlsSecret: httpbin-linuxyunwei-com-tls  <span class=c1>## 用来存储证书的 secret 名称</span>
</span></span><span class=line><span class=cl>      tlsIssuer: letsencrypt    <span class=c1>## 指定使用 let&#39;s encrypt</span>
</span></span><span class=line><span class=cl>    fallbackForInvalidSecret: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    renewBeforeDays: <span class=m>30</span>
</span></span><span class=line><span class=cl>    version: <span class=s2>&#34;20250118113351&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 稍等一会之后就可以看到证书已经创建好了</span>
</span></span><span class=line><span class=cl>$ kubectl get secret -n higress-system
</span></span><span class=line><span class=cl>NAME                          TYPE                DATA   AGE
</span></span><span class=line><span class=cl>httpbin-linuxyunwei-com-tls   kubernetes.io/tls   <span class=m>2</span>      6m36s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 我们现在使用 https 访问下试试</span>
</span></span><span class=line><span class=cl>$ curl -v https://httpbin.linuxyunwei.com/status/200
</span></span><span class=line><span class=cl>* Host httpbin.linuxyunwei.com:443 was resolved.
</span></span><span class=line><span class=cl>* IPv6: <span class=o>(</span>none<span class=o>)</span>
</span></span><span class=line><span class=cl>* IPv4: 101.37.18.109
</span></span><span class=line><span class=cl>*   Trying 101.37.18.109:443...
</span></span><span class=line><span class=cl>* Connected to httpbin.linuxyunwei.com <span class=o>(</span>101.37.18.109<span class=o>)</span> port <span class=m>443</span>
</span></span><span class=line><span class=cl>* ALPN: curl offers h2,http/1.1
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS handshake, Client hello <span class=o>(</span>1<span class=o>)</span>:
</span></span><span class=line><span class=cl>*  CAfile: /etc/ssl/certs/ca-certificates.crt
</span></span><span class=line><span class=cl>*  CApath: /etc/ssl/certs
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Server hello <span class=o>(</span>2<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Encrypted Extensions <span class=o>(</span>8<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Certificate <span class=o>(</span>11<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, CERT verify <span class=o>(</span>15<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Finished <span class=o>(</span>20<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS change cipher, Change cipher spec <span class=o>(</span>1<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS handshake, Finished <span class=o>(</span>20<span class=o>)</span>:
</span></span><span class=line><span class=cl>* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / X25519 / id-ecPublicKey
</span></span><span class=line><span class=cl>* ALPN: server accepted http/1.1
</span></span><span class=line><span class=cl>* Server certificate:
</span></span><span class=line><span class=cl>*  subject: <span class=nv>CN</span><span class=o>=</span>httpbin.linuxyunwei.com
</span></span><span class=line><span class=cl>*  start date: Jan <span class=m>19</span> 03:30:15 <span class=m>2025</span> GMT
</span></span><span class=line><span class=cl>*  expire date: Apr <span class=m>19</span> 03:30:14 <span class=m>2025</span> GMT
</span></span><span class=line><span class=cl>*  subjectAltName: host <span class=s2>&#34;httpbin.linuxyunwei.com&#34;</span> matched cert<span class=s1>&#39;s &#34;httpbin.linuxyunwei.com&#34;
</span></span></span><span class=line><span class=cl><span class=s1>*  issuer: C=US; O=Let&#39;</span>s Encrypt<span class=p>;</span> <span class=nv>CN</span><span class=o>=</span>E6
</span></span><span class=line><span class=cl>*  SSL certificate verify ok.
</span></span><span class=line><span class=cl>*   Certificate level 0: Public key <span class=nb>type</span> EC/prime256v1 <span class=o>(</span>256/128 Bits/secBits<span class=o>)</span>, signed using ecdsa-with-SHA384
</span></span><span class=line><span class=cl>*   Certificate level 1: Public key <span class=nb>type</span> EC/secp384r1 <span class=o>(</span>384/192 Bits/secBits<span class=o>)</span>, signed using sha256WithRSAEncryption
</span></span><span class=line><span class=cl>*   Certificate level 2: Public key <span class=nb>type</span> RSA <span class=o>(</span>4096/152 Bits/secBits<span class=o>)</span>, signed using sha256WithRSAEncryption
</span></span><span class=line><span class=cl>* using HTTP/1.x
</span></span><span class=line><span class=cl>&gt; GET /status/200 HTTP/1.1
</span></span><span class=line><span class=cl>&gt; Host: httpbin.linuxyunwei.com
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/8.5.0
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt;
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Newsession Ticket <span class=o>(</span>4<span class=o>)</span>:
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Newsession Ticket <span class=o>(</span>4<span class=o>)</span>:
</span></span><span class=line><span class=cl>* old SSL session ID is stale, removing
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>&lt; access-control-allow-credentials: <span class=nb>true</span>
</span></span><span class=line><span class=cl>&lt; access-control-allow-origin: *
</span></span><span class=line><span class=cl>&lt; content-type: text/plain<span class=p>;</span> <span class=nv>charset</span><span class=o>=</span>utf-8
</span></span><span class=line><span class=cl>&lt; date: Sun, <span class=m>19</span> Jan <span class=m>2025</span> 04:37:32 GMT
</span></span><span class=line><span class=cl>&lt; content-length: <span class=m>0</span>
</span></span><span class=line><span class=cl>&lt; req-cost-time: <span class=m>1</span>
</span></span><span class=line><span class=cl>&lt; req-arrive-time: <span class=m>1737261452765</span>
</span></span><span class=line><span class=cl>&lt; resp-start-time: <span class=m>1737261452767</span>
</span></span><span class=line><span class=cl>&lt; x-envoy-upstream-service-time: <span class=m>1</span>
</span></span><span class=line><span class=cl>&lt; server: istio-envoy
</span></span><span class=line><span class=cl>&lt;
</span></span><span class=line><span class=cl>* Connection <span class=c1>#0 to host httpbin.linuxyunwei.com left intact</span>
</span></span></code></pre></div><p>如果证书未能正常申请， 可以通过如下命令查看控制端的日志进行排查</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl logs --tail <span class=m>200</span> -f -n higress-system -l <span class=nv>higress</span><span class=o>=</span>higress-controller -c discovery
</span></span></code></pre></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://docs.k3s.io/zh/installation/configuration>Installation Configuration Options</a></li><li><a href=https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#_helmchartinflationgenerator_>Kustomize Built-Ins | helmCharts</a></li><li><a href=https://github.com/alibaba/higress/pull/854>feat:add higress automatic https by 2456868764 · Pull Request #854 · alibaba/higress · GitHub</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://linuxyunwei.com/2020/05/20/%E4%BD%BF%E7%94%A8kubeadm%E6%9B%B4%E6%96%B0%E9%9B%86%E7%BE%A4/><span class=title>»</span><br><span>使用Kubeadm更新集群</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on x" href="https://x.com/intent/tweet/?text=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress&amp;url=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f&amp;title=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress&amp;summary=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress&amp;source=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f&title=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on whatsapp" href="https://api.whatsapp.com/send?text=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress%20-%20https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on telegram" href="https://telegram.me/share/url?text=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress&amp;url=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 在阿里云ECS中部署k3s+Higress on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e5%9c%a8%e9%98%bf%e9%87%8c%e4%ba%91ECS%e4%b8%ad%e9%83%a8%e7%bd%b2k3s%2bHigress&u=https%3a%2f%2flinuxyunwei.com%2f2025%2f01%2f14%2f%25E5%259C%25A8%25E9%2598%25BF%25E9%2587%258C%25E4%25BA%2591ecs%25E4%25B8%25AD%25E9%2583%25A8%25E7%25BD%25B2k3s-higress%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>戴先森 · <a rel="license noopener" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a> <a href=http://www.miitbeian.gov.cn/ target=_blank>沪ICP备13017200号-1</a> <a target=_blank rel=noreferrer href="https://beian.mps.gov.cn/#/query/webSearch?code=31011702890206">沪公网安备31011702890206号</a><br></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>